<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>20 Evaluation | Advanced R</title>
  <meta name="description" content="20 Evaluation | Advanced R" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="20 Evaluation | Advanced R" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="20 Evaluation | Advanced R" />
  
  
  

<meta name="author" content="Hadley Wickham" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="quasiquotation.html"/>
<link rel="next" href="translation.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-141212623-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-141212623-1');
</script>



<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="adv-r.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">Advanced R</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#other-books"><i class="fa fa-check"></i>Other books</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#why-r"><i class="fa fa-check"></i><b>1.1</b> Why R?</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#who-should-read"><i class="fa fa-check"></i><b>1.2</b> Who should read this book</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#what-you-will-get"><i class="fa fa-check"></i><b>1.3</b> What you will get out of this book</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#what-you-will-not-learn"><i class="fa fa-check"></i><b>1.4</b> What you will not learn</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#meta-techniques"><i class="fa fa-check"></i><b>1.5</b> Meta-techniques</a></li>
<li class="chapter" data-level="1.6" data-path="introduction.html"><a href="introduction.html#recommended-reading"><i class="fa fa-check"></i><b>1.6</b> Recommended reading</a></li>
<li class="chapter" data-level="1.7" data-path="introduction.html"><a href="introduction.html#getting-help"><i class="fa fa-check"></i><b>1.7</b> Getting help</a></li>
<li class="chapter" data-level="1.8" data-path="introduction.html"><a href="introduction.html#intro-ack"><i class="fa fa-check"></i><b>1.8</b> Acknowledgments</a></li>
<li class="chapter" data-level="1.9" data-path="introduction.html"><a href="introduction.html#conventions"><i class="fa fa-check"></i><b>1.9</b> Conventions</a></li>
<li class="chapter" data-level="1.10" data-path="introduction.html"><a href="introduction.html#colophon"><i class="fa fa-check"></i><b>1.10</b> Colophon</a></li>
</ul></li>
<li class="part"><span><b>I Foundations</b></span></li>
<li class="chapter" data-level="" data-path="foundations-intro.html"><a href="foundations-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="2" data-path="names-values.html"><a href="names-values.html"><i class="fa fa-check"></i><b>2</b> Names and values</a>
<ul>
<li class="chapter" data-level="2.1" data-path="names-values.html"><a href="names-values.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="names-values.html"><a href="names-values.html#quiz"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="names-values.html"><a href="names-values.html#outline"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="names-values.html"><a href="names-values.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="" data-path="names-values.html"><a href="names-values.html#sources"><i class="fa fa-check"></i>Sources</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="names-values.html"><a href="names-values.html#binding-basics"><i class="fa fa-check"></i><b>2.2</b> Binding basics</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="names-values.html"><a href="names-values.html#non-syntactic"><i class="fa fa-check"></i><b>2.2.1</b> Non-syntactic names</a></li>
<li class="chapter" data-level="2.2.2" data-path="names-values.html"><a href="names-values.html#exercises"><i class="fa fa-check"></i><b>2.2.2</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="names-values.html"><a href="names-values.html#copy-on-modify"><i class="fa fa-check"></i><b>2.3</b> Copy-on-modify</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="names-values.html"><a href="names-values.html#tracemem"><i class="fa fa-check"></i><b>2.3.1</b> <code>tracemem()</code></a></li>
<li class="chapter" data-level="2.3.2" data-path="names-values.html"><a href="names-values.html#function-calls"><i class="fa fa-check"></i><b>2.3.2</b> Function calls</a></li>
<li class="chapter" data-level="2.3.3" data-path="names-values.html"><a href="names-values.html#list-references"><i class="fa fa-check"></i><b>2.3.3</b> Lists</a></li>
<li class="chapter" data-level="2.3.4" data-path="names-values.html"><a href="names-values.html#df-modify"><i class="fa fa-check"></i><b>2.3.4</b> Data frames</a></li>
<li class="chapter" data-level="2.3.5" data-path="names-values.html"><a href="names-values.html#character-vectors"><i class="fa fa-check"></i><b>2.3.5</b> Character vectors</a></li>
<li class="chapter" data-level="2.3.6" data-path="names-values.html"><a href="names-values.html#exercises-1"><i class="fa fa-check"></i><b>2.3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="names-values.html"><a href="names-values.html#object-size"><i class="fa fa-check"></i><b>2.4</b> Object size</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="names-values.html"><a href="names-values.html#exercises-2"><i class="fa fa-check"></i><b>2.4.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="names-values.html"><a href="names-values.html#modify-in-place"><i class="fa fa-check"></i><b>2.5</b> Modify-in-place</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="names-values.html"><a href="names-values.html#single-binding"><i class="fa fa-check"></i><b>2.5.1</b> Objects with a single binding</a></li>
<li class="chapter" data-level="2.5.2" data-path="names-values.html"><a href="names-values.html#env-modify"><i class="fa fa-check"></i><b>2.5.2</b> Environments</a></li>
<li class="chapter" data-level="2.5.3" data-path="names-values.html"><a href="names-values.html#exercises-3"><i class="fa fa-check"></i><b>2.5.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="names-values.html"><a href="names-values.html#gc"><i class="fa fa-check"></i><b>2.6</b> Unbinding and the garbage collector</a></li>
<li class="chapter" data-level="2.7" data-path="names-values.html"><a href="names-values.html#names-values-answers"><i class="fa fa-check"></i><b>2.7</b> Quiz answers</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="vectors-chap.html"><a href="vectors-chap.html"><i class="fa fa-check"></i><b>3</b> Vectors</a>
<ul>
<li class="chapter" data-level="3.1" data-path="vectors-chap.html"><a href="vectors-chap.html#introduction-2"><i class="fa fa-check"></i><b>3.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="vectors-chap.html"><a href="vectors-chap.html#quiz-1"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="vectors-chap.html"><a href="vectors-chap.html#outline-1"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="vectors-chap.html"><a href="vectors-chap.html#atomic-vectors"><i class="fa fa-check"></i><b>3.2</b> Atomic vectors</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="vectors-chap.html"><a href="vectors-chap.html#scalars"><i class="fa fa-check"></i><b>3.2.1</b> Scalars</a></li>
<li class="chapter" data-level="3.2.2" data-path="vectors-chap.html"><a href="vectors-chap.html#atomic-constructing"><i class="fa fa-check"></i><b>3.2.2</b> Making longer vectors with <code>c()</code></a></li>
<li class="chapter" data-level="3.2.3" data-path="vectors-chap.html"><a href="vectors-chap.html#missing-values"><i class="fa fa-check"></i><b>3.2.3</b> Missing values</a></li>
<li class="chapter" data-level="3.2.4" data-path="vectors-chap.html"><a href="vectors-chap.html#testing-and-coercion"><i class="fa fa-check"></i><b>3.2.4</b> Testing and coercion</a></li>
<li class="chapter" data-level="3.2.5" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-4"><i class="fa fa-check"></i><b>3.2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="vectors-chap.html"><a href="vectors-chap.html#attributes"><i class="fa fa-check"></i><b>3.3</b> Attributes</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="vectors-chap.html"><a href="vectors-chap.html#getting-and-setting"><i class="fa fa-check"></i><b>3.3.1</b> Getting and setting</a></li>
<li class="chapter" data-level="3.3.2" data-path="vectors-chap.html"><a href="vectors-chap.html#attr-names"><i class="fa fa-check"></i><b>3.3.2</b> Names</a></li>
<li class="chapter" data-level="3.3.3" data-path="vectors-chap.html"><a href="vectors-chap.html#attr-dims"><i class="fa fa-check"></i><b>3.3.3</b> Dimensions</a></li>
<li class="chapter" data-level="3.3.4" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-5"><i class="fa fa-check"></i><b>3.3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="vectors-chap.html"><a href="vectors-chap.html#s3-atomic-vectors"><i class="fa fa-check"></i><b>3.4</b> S3 atomic vectors</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="vectors-chap.html"><a href="vectors-chap.html#factors"><i class="fa fa-check"></i><b>3.4.1</b> Factors</a></li>
<li class="chapter" data-level="3.4.2" data-path="vectors-chap.html"><a href="vectors-chap.html#dates"><i class="fa fa-check"></i><b>3.4.2</b> Dates</a></li>
<li class="chapter" data-level="3.4.3" data-path="vectors-chap.html"><a href="vectors-chap.html#date-times"><i class="fa fa-check"></i><b>3.4.3</b> Date-times</a></li>
<li class="chapter" data-level="3.4.4" data-path="vectors-chap.html"><a href="vectors-chap.html#durations"><i class="fa fa-check"></i><b>3.4.4</b> Durations</a></li>
<li class="chapter" data-level="3.4.5" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-6"><i class="fa fa-check"></i><b>3.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="vectors-chap.html"><a href="vectors-chap.html#lists"><i class="fa fa-check"></i><b>3.5</b> Lists</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="vectors-chap.html"><a href="vectors-chap.html#list-creating"><i class="fa fa-check"></i><b>3.5.1</b> Creating</a></li>
<li class="chapter" data-level="3.5.2" data-path="vectors-chap.html"><a href="vectors-chap.html#list-types"><i class="fa fa-check"></i><b>3.5.2</b> Testing and coercion</a></li>
<li class="chapter" data-level="3.5.3" data-path="vectors-chap.html"><a href="vectors-chap.html#list-array"><i class="fa fa-check"></i><b>3.5.3</b> Matrices and arrays</a></li>
<li class="chapter" data-level="3.5.4" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-7"><i class="fa fa-check"></i><b>3.5.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="vectors-chap.html"><a href="vectors-chap.html#tibble"><i class="fa fa-check"></i><b>3.6</b> Data frames and tibbles</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="vectors-chap.html"><a href="vectors-chap.html#df-create"><i class="fa fa-check"></i><b>3.6.1</b> Creating</a></li>
<li class="chapter" data-level="3.6.2" data-path="vectors-chap.html"><a href="vectors-chap.html#rownames"><i class="fa fa-check"></i><b>3.6.2</b> Row names</a></li>
<li class="chapter" data-level="3.6.3" data-path="vectors-chap.html"><a href="vectors-chap.html#printing"><i class="fa fa-check"></i><b>3.6.3</b> Printing</a></li>
<li class="chapter" data-level="3.6.4" data-path="vectors-chap.html"><a href="vectors-chap.html#safe-subsetting"><i class="fa fa-check"></i><b>3.6.4</b> Subsetting</a></li>
<li class="chapter" data-level="3.6.5" data-path="vectors-chap.html"><a href="vectors-chap.html#df-test-coerce"><i class="fa fa-check"></i><b>3.6.5</b> Testing and coercing</a></li>
<li class="chapter" data-level="3.6.6" data-path="vectors-chap.html"><a href="vectors-chap.html#list-columns"><i class="fa fa-check"></i><b>3.6.6</b> List columns</a></li>
<li class="chapter" data-level="3.6.7" data-path="vectors-chap.html"><a href="vectors-chap.html#matrix-and-data-frame-columns"><i class="fa fa-check"></i><b>3.6.7</b> Matrix and data frame columns</a></li>
<li class="chapter" data-level="3.6.8" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-8"><i class="fa fa-check"></i><b>3.6.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="vectors-chap.html"><a href="vectors-chap.html#null"><i class="fa fa-check"></i><b>3.7</b> <code>NULL</code></a></li>
<li class="chapter" data-level="3.8" data-path="vectors-chap.html"><a href="vectors-chap.html#data-structure-answers"><i class="fa fa-check"></i><b>3.8</b> Quiz answers</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="subsetting.html"><a href="subsetting.html"><i class="fa fa-check"></i><b>4</b> Subsetting</a>
<ul>
<li class="chapter" data-level="4.1" data-path="subsetting.html"><a href="subsetting.html#introduction-3"><i class="fa fa-check"></i><b>4.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#quiz-2"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#outline-2"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="subsetting.html"><a href="subsetting.html#subset-multiple"><i class="fa fa-check"></i><b>4.2</b> Selecting multiple elements</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="subsetting.html"><a href="subsetting.html#atomic-vectors-1"><i class="fa fa-check"></i><b>4.2.1</b> Atomic vectors</a></li>
<li class="chapter" data-level="4.2.2" data-path="subsetting.html"><a href="subsetting.html#lists-1"><i class="fa fa-check"></i><b>4.2.2</b> Lists</a></li>
<li class="chapter" data-level="4.2.3" data-path="subsetting.html"><a href="subsetting.html#matrix-subsetting"><i class="fa fa-check"></i><b>4.2.3</b> Matrices and arrays</a></li>
<li class="chapter" data-level="4.2.4" data-path="subsetting.html"><a href="subsetting.html#df-subsetting"><i class="fa fa-check"></i><b>4.2.4</b> Data frames and tibbles</a></li>
<li class="chapter" data-level="4.2.5" data-path="subsetting.html"><a href="subsetting.html#simplify-preserve"><i class="fa fa-check"></i><b>4.2.5</b> Preserving dimensionality</a></li>
<li class="chapter" data-level="4.2.6" data-path="subsetting.html"><a href="subsetting.html#exercises-9"><i class="fa fa-check"></i><b>4.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="subsetting.html"><a href="subsetting.html#subset-single"><i class="fa fa-check"></i><b>4.3</b> Selecting a single element</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="subsetting.html"><a href="subsetting.html#section"><i class="fa fa-check"></i><b>4.3.1</b> <code>[[</code></a></li>
<li class="chapter" data-level="4.3.2" data-path="subsetting.html"><a href="subsetting.html#section-1"><i class="fa fa-check"></i><b>4.3.2</b> <code>$</code></a></li>
<li class="chapter" data-level="4.3.3" data-path="subsetting.html"><a href="subsetting.html#subsetting-oob"><i class="fa fa-check"></i><b>4.3.3</b> Missing and out-of-bounds indices</a></li>
<li class="chapter" data-level="4.3.4" data-path="subsetting.html"><a href="subsetting.html#and-slot"><i class="fa fa-check"></i><b>4.3.4</b> <code>@</code> and <code>slot()</code></a></li>
<li class="chapter" data-level="4.3.5" data-path="subsetting.html"><a href="subsetting.html#exercises-10"><i class="fa fa-check"></i><b>4.3.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="subsetting.html"><a href="subsetting.html#subassignment"><i class="fa fa-check"></i><b>4.4</b> Subsetting and assignment</a></li>
<li class="chapter" data-level="4.5" data-path="subsetting.html"><a href="subsetting.html#applications"><i class="fa fa-check"></i><b>4.5</b> Applications</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="subsetting.html"><a href="subsetting.html#lookup-tables"><i class="fa fa-check"></i><b>4.5.1</b> Lookup tables (character subsetting)</a></li>
<li class="chapter" data-level="4.5.2" data-path="subsetting.html"><a href="subsetting.html#matching-merging"><i class="fa fa-check"></i><b>4.5.2</b> Matching and merging by hand (integer subsetting)</a></li>
<li class="chapter" data-level="4.5.3" data-path="subsetting.html"><a href="subsetting.html#random-samples-and-bootstraps-integer-subsetting"><i class="fa fa-check"></i><b>4.5.3</b> Random samples and bootstraps (integer subsetting)</a></li>
<li class="chapter" data-level="4.5.4" data-path="subsetting.html"><a href="subsetting.html#ordering-integer-subsetting"><i class="fa fa-check"></i><b>4.5.4</b> Ordering (integer subsetting)</a></li>
<li class="chapter" data-level="4.5.5" data-path="subsetting.html"><a href="subsetting.html#expanding-aggregated-counts-integer-subsetting"><i class="fa fa-check"></i><b>4.5.5</b> Expanding aggregated counts (integer subsetting)</a></li>
<li class="chapter" data-level="4.5.6" data-path="subsetting.html"><a href="subsetting.html#removing-columns-from-data-frames-character"><i class="fa fa-check"></i><b>4.5.6</b> Removing columns from data frames (character )</a></li>
<li class="chapter" data-level="4.5.7" data-path="subsetting.html"><a href="subsetting.html#selecting-rows-based-on-a-condition-logical-subsetting"><i class="fa fa-check"></i><b>4.5.7</b> Selecting rows based on a condition (logical subsetting)</a></li>
<li class="chapter" data-level="4.5.8" data-path="subsetting.html"><a href="subsetting.html#boolean-algebra-versus-sets-logical-and-integer"><i class="fa fa-check"></i><b>4.5.8</b> Boolean algebra versus sets (logical and integer )</a></li>
<li class="chapter" data-level="4.5.9" data-path="subsetting.html"><a href="subsetting.html#exercises-11"><i class="fa fa-check"></i><b>4.5.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="subsetting.html"><a href="subsetting.html#subsetting-answers"><i class="fa fa-check"></i><b>4.6</b> Quiz answers</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="control-flow.html"><a href="control-flow.html"><i class="fa fa-check"></i><b>5</b> Control flow</a>
<ul>
<li class="chapter" data-level="5.1" data-path="control-flow.html"><a href="control-flow.html#introduction-4"><i class="fa fa-check"></i><b>5.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#quiz-3"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#outline-3"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="control-flow.html"><a href="control-flow.html#choices"><i class="fa fa-check"></i><b>5.2</b> Choices</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="control-flow.html"><a href="control-flow.html#invalid-inputs"><i class="fa fa-check"></i><b>5.2.1</b> Invalid inputs</a></li>
<li class="chapter" data-level="5.2.2" data-path="control-flow.html"><a href="control-flow.html#vectorised-if"><i class="fa fa-check"></i><b>5.2.2</b> Vectorised if</a></li>
<li class="chapter" data-level="5.2.3" data-path="control-flow.html"><a href="control-flow.html#switch"><i class="fa fa-check"></i><b>5.2.3</b> <code>switch()</code> statement</a></li>
<li class="chapter" data-level="5.2.4" data-path="control-flow.html"><a href="control-flow.html#exercises-12"><i class="fa fa-check"></i><b>5.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="control-flow.html"><a href="control-flow.html#loops"><i class="fa fa-check"></i><b>5.3</b> Loops</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="control-flow.html"><a href="control-flow.html#common-pitfalls"><i class="fa fa-check"></i><b>5.3.1</b> Common pitfalls</a></li>
<li class="chapter" data-level="5.3.2" data-path="control-flow.html"><a href="control-flow.html#for-family"><i class="fa fa-check"></i><b>5.3.2</b> Related tools</a></li>
<li class="chapter" data-level="5.3.3" data-path="control-flow.html"><a href="control-flow.html#exercises-13"><i class="fa fa-check"></i><b>5.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="control-flow.html"><a href="control-flow.html#control-flow-answers"><i class="fa fa-check"></i><b>5.4</b> Quiz answers</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>6</b> Functions</a>
<ul>
<li class="chapter" data-level="6.1" data-path="functions.html"><a href="functions.html#introduction-5"><i class="fa fa-check"></i><b>6.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#quiz-4"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#outline-4"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="functions.html"><a href="functions.html#function-fundamentals"><i class="fa fa-check"></i><b>6.2</b> Function fundamentals</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="functions.html"><a href="functions.html#fun-components"><i class="fa fa-check"></i><b>6.2.1</b> Function components</a></li>
<li class="chapter" data-level="6.2.2" data-path="functions.html"><a href="functions.html#primitive-functions"><i class="fa fa-check"></i><b>6.2.2</b> Primitive functions</a></li>
<li class="chapter" data-level="6.2.3" data-path="functions.html"><a href="functions.html#first-class-functions"><i class="fa fa-check"></i><b>6.2.3</b> First-class functions</a></li>
<li class="chapter" data-level="6.2.4" data-path="functions.html"><a href="functions.html#invoking-a-function"><i class="fa fa-check"></i><b>6.2.4</b> Invoking a function</a></li>
<li class="chapter" data-level="6.2.5" data-path="functions.html"><a href="functions.html#exercises-14"><i class="fa fa-check"></i><b>6.2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="functions.html"><a href="functions.html#function-composition"><i class="fa fa-check"></i><b>6.3</b> Function composition</a></li>
<li class="chapter" data-level="6.4" data-path="functions.html"><a href="functions.html#lexical-scoping"><i class="fa fa-check"></i><b>6.4</b> Lexical scoping</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="functions.html"><a href="functions.html#name-masking"><i class="fa fa-check"></i><b>6.4.1</b> Name masking</a></li>
<li class="chapter" data-level="6.4.2" data-path="functions.html"><a href="functions.html#functions-versus-variables"><i class="fa fa-check"></i><b>6.4.2</b> Functions versus variables</a></li>
<li class="chapter" data-level="6.4.3" data-path="functions.html"><a href="functions.html#fresh-start"><i class="fa fa-check"></i><b>6.4.3</b> A fresh start</a></li>
<li class="chapter" data-level="6.4.4" data-path="functions.html"><a href="functions.html#dynamic-lookup"><i class="fa fa-check"></i><b>6.4.4</b> Dynamic lookup</a></li>
<li class="chapter" data-level="6.4.5" data-path="functions.html"><a href="functions.html#exercises-15"><i class="fa fa-check"></i><b>6.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="functions.html"><a href="functions.html#lazy-evaluation"><i class="fa fa-check"></i><b>6.5</b> Lazy evaluation</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="functions.html"><a href="functions.html#promises"><i class="fa fa-check"></i><b>6.5.1</b> Promises</a></li>
<li class="chapter" data-level="6.5.2" data-path="functions.html"><a href="functions.html#default-arguments"><i class="fa fa-check"></i><b>6.5.2</b> Default arguments</a></li>
<li class="chapter" data-level="6.5.3" data-path="functions.html"><a href="functions.html#missing-arguments"><i class="fa fa-check"></i><b>6.5.3</b> Missing arguments</a></li>
<li class="chapter" data-level="6.5.4" data-path="functions.html"><a href="functions.html#exercises-16"><i class="fa fa-check"></i><b>6.5.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="functions.html"><a href="functions.html#fun-dot-dot-dot"><i class="fa fa-check"></i><b>6.6</b> <code>...</code> (dot-dot-dot)</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="functions.html"><a href="functions.html#exercises-17"><i class="fa fa-check"></i><b>6.6.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="functions.html"><a href="functions.html#exiting-a-function"><i class="fa fa-check"></i><b>6.7</b> Exiting a function</a>
<ul>
<li class="chapter" data-level="6.7.1" data-path="functions.html"><a href="functions.html#implicit-versus-explicit-returns"><i class="fa fa-check"></i><b>6.7.1</b> Implicit versus explicit returns</a></li>
<li class="chapter" data-level="6.7.2" data-path="functions.html"><a href="functions.html#invisible"><i class="fa fa-check"></i><b>6.7.2</b> Invisible values</a></li>
<li class="chapter" data-level="6.7.3" data-path="functions.html"><a href="functions.html#errors"><i class="fa fa-check"></i><b>6.7.3</b> Errors</a></li>
<li class="chapter" data-level="6.7.4" data-path="functions.html"><a href="functions.html#on-exit"><i class="fa fa-check"></i><b>6.7.4</b> Exit handlers</a></li>
<li class="chapter" data-level="6.7.5" data-path="functions.html"><a href="functions.html#exercises-18"><i class="fa fa-check"></i><b>6.7.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.8" data-path="functions.html"><a href="functions.html#function-forms"><i class="fa fa-check"></i><b>6.8</b> Function forms</a>
<ul>
<li class="chapter" data-level="6.8.1" data-path="functions.html"><a href="functions.html#prefix-transform"><i class="fa fa-check"></i><b>6.8.1</b> Rewriting to prefix form</a></li>
<li class="chapter" data-level="6.8.2" data-path="functions.html"><a href="functions.html#prefix-form"><i class="fa fa-check"></i><b>6.8.2</b> Prefix form</a></li>
<li class="chapter" data-level="6.8.3" data-path="functions.html"><a href="functions.html#infix-functions"><i class="fa fa-check"></i><b>6.8.3</b> Infix functions</a></li>
<li class="chapter" data-level="6.8.4" data-path="functions.html"><a href="functions.html#replacement-functions"><i class="fa fa-check"></i><b>6.8.4</b> Replacement functions</a></li>
<li class="chapter" data-level="6.8.5" data-path="functions.html"><a href="functions.html#special-forms"><i class="fa fa-check"></i><b>6.8.5</b> Special forms</a></li>
<li class="chapter" data-level="6.8.6" data-path="functions.html"><a href="functions.html#exercises-19"><i class="fa fa-check"></i><b>6.8.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="functions.html"><a href="functions.html#function-answers"><i class="fa fa-check"></i><b>6.9</b> Quiz answers</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="environments.html"><a href="environments.html"><i class="fa fa-check"></i><b>7</b> Environments</a>
<ul>
<li class="chapter" data-level="7.1" data-path="environments.html"><a href="environments.html#introduction-6"><i class="fa fa-check"></i><b>7.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#quiz-5"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#outline-5"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="environments.html"><a href="environments.html#env-basics"><i class="fa fa-check"></i><b>7.2</b> Environment basics</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="environments.html"><a href="environments.html#basics"><i class="fa fa-check"></i><b>7.2.1</b> Basics</a></li>
<li class="chapter" data-level="7.2.2" data-path="environments.html"><a href="environments.html#important-environments"><i class="fa fa-check"></i><b>7.2.2</b> Important environments</a></li>
<li class="chapter" data-level="7.2.3" data-path="environments.html"><a href="environments.html#parents"><i class="fa fa-check"></i><b>7.2.3</b> Parents</a></li>
<li class="chapter" data-level="7.2.4" data-path="environments.html"><a href="environments.html#super-assignment--"><i class="fa fa-check"></i><b>7.2.4</b> Super assignment, <code>&lt;&lt;-</code></a></li>
<li class="chapter" data-level="7.2.5" data-path="environments.html"><a href="environments.html#getting-and-setting-1"><i class="fa fa-check"></i><b>7.2.5</b> Getting and setting</a></li>
<li class="chapter" data-level="7.2.6" data-path="environments.html"><a href="environments.html#advanced-bindings"><i class="fa fa-check"></i><b>7.2.6</b> Advanced bindings</a></li>
<li class="chapter" data-level="7.2.7" data-path="environments.html"><a href="environments.html#exercises-20"><i class="fa fa-check"></i><b>7.2.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="environments.html"><a href="environments.html#env-recursion"><i class="fa fa-check"></i><b>7.3</b> Recursing over environments</a>
<ul>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#iteration-versus-recursion"><i class="fa fa-check"></i>Iteration versus recursion</a></li>
<li class="chapter" data-level="7.3.1" data-path="environments.html"><a href="environments.html#exercises-21"><i class="fa fa-check"></i><b>7.3.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="environments.html"><a href="environments.html#special-environments"><i class="fa fa-check"></i><b>7.4</b> Special environments</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="environments.html"><a href="environments.html#search-path"><i class="fa fa-check"></i><b>7.4.1</b> Package environments and the search path</a></li>
<li class="chapter" data-level="7.4.2" data-path="environments.html"><a href="environments.html#function-environments"><i class="fa fa-check"></i><b>7.4.2</b> The function environment</a></li>
<li class="chapter" data-level="7.4.3" data-path="environments.html"><a href="environments.html#namespaces"><i class="fa fa-check"></i><b>7.4.3</b> Namespaces</a></li>
<li class="chapter" data-level="7.4.4" data-path="environments.html"><a href="environments.html#execution-environments"><i class="fa fa-check"></i><b>7.4.4</b> Execution environments</a></li>
<li class="chapter" data-level="7.4.5" data-path="environments.html"><a href="environments.html#exercises-22"><i class="fa fa-check"></i><b>7.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="environments.html"><a href="environments.html#call-stack"><i class="fa fa-check"></i><b>7.5</b> Call stacks</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="environments.html"><a href="environments.html#simple-stack"><i class="fa fa-check"></i><b>7.5.1</b> Simple call stacks</a></li>
<li class="chapter" data-level="7.5.2" data-path="environments.html"><a href="environments.html#lazy-call-stack"><i class="fa fa-check"></i><b>7.5.2</b> Lazy evaluation</a></li>
<li class="chapter" data-level="7.5.3" data-path="environments.html"><a href="environments.html#frames"><i class="fa fa-check"></i><b>7.5.3</b> Frames</a></li>
<li class="chapter" data-level="7.5.4" data-path="environments.html"><a href="environments.html#dynamic-scope"><i class="fa fa-check"></i><b>7.5.4</b> Dynamic scope</a></li>
<li class="chapter" data-level="7.5.5" data-path="environments.html"><a href="environments.html#exercises-23"><i class="fa fa-check"></i><b>7.5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="environments.html"><a href="environments.html#explicit-envs"><i class="fa fa-check"></i><b>7.6</b> As data structures</a></li>
<li class="chapter" data-level="7.7" data-path="environments.html"><a href="environments.html#env-answers"><i class="fa fa-check"></i><b>7.7</b> Quiz answers</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="conditions.html"><a href="conditions.html"><i class="fa fa-check"></i><b>8</b> Conditions</a>
<ul>
<li class="chapter" data-level="8.1" data-path="conditions.html"><a href="conditions.html#introduction-7"><i class="fa fa-check"></i><b>8.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#quiz-6"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#outline-6"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="8.1.1" data-path="conditions.html"><a href="conditions.html#prerequisites-2"><i class="fa fa-check"></i><b>8.1.1</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="conditions.html"><a href="conditions.html#signalling-conditions"><i class="fa fa-check"></i><b>8.2</b> Signalling conditions</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="conditions.html"><a href="conditions.html#errors-1"><i class="fa fa-check"></i><b>8.2.1</b> Errors</a></li>
<li class="chapter" data-level="8.2.2" data-path="conditions.html"><a href="conditions.html#warnings"><i class="fa fa-check"></i><b>8.2.2</b> Warnings</a></li>
<li class="chapter" data-level="8.2.3" data-path="conditions.html"><a href="conditions.html#messages"><i class="fa fa-check"></i><b>8.2.3</b> Messages</a></li>
<li class="chapter" data-level="8.2.4" data-path="conditions.html"><a href="conditions.html#exercises-24"><i class="fa fa-check"></i><b>8.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="conditions.html"><a href="conditions.html#ignoring-conditions"><i class="fa fa-check"></i><b>8.3</b> Ignoring conditions</a></li>
<li class="chapter" data-level="8.4" data-path="conditions.html"><a href="conditions.html#handling-conditions"><i class="fa fa-check"></i><b>8.4</b> Handling conditions</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="conditions.html"><a href="conditions.html#condition-objects"><i class="fa fa-check"></i><b>8.4.1</b> Condition objects</a></li>
<li class="chapter" data-level="8.4.2" data-path="conditions.html"><a href="conditions.html#exiting-handlers"><i class="fa fa-check"></i><b>8.4.2</b> Exiting handlers</a></li>
<li class="chapter" data-level="8.4.3" data-path="conditions.html"><a href="conditions.html#calling-handlers"><i class="fa fa-check"></i><b>8.4.3</b> Calling handlers</a></li>
<li class="chapter" data-level="8.4.4" data-path="conditions.html"><a href="conditions.html#call-stacks"><i class="fa fa-check"></i><b>8.4.4</b> Call stacks</a></li>
<li class="chapter" data-level="8.4.5" data-path="conditions.html"><a href="conditions.html#exercises-25"><i class="fa fa-check"></i><b>8.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="conditions.html"><a href="conditions.html#custom-conditions"><i class="fa fa-check"></i><b>8.5</b> Custom conditions</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="conditions.html"><a href="conditions.html#motivation"><i class="fa fa-check"></i><b>8.5.1</b> Motivation</a></li>
<li class="chapter" data-level="8.5.2" data-path="conditions.html"><a href="conditions.html#signalling"><i class="fa fa-check"></i><b>8.5.2</b> Signalling</a></li>
<li class="chapter" data-level="8.5.3" data-path="conditions.html"><a href="conditions.html#handling"><i class="fa fa-check"></i><b>8.5.3</b> Handling</a></li>
<li class="chapter" data-level="8.5.4" data-path="conditions.html"><a href="conditions.html#exercises-26"><i class="fa fa-check"></i><b>8.5.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="conditions.html"><a href="conditions.html#condition-applications"><i class="fa fa-check"></i><b>8.6</b> Applications</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="conditions.html"><a href="conditions.html#failure-value"><i class="fa fa-check"></i><b>8.6.1</b> Failure value</a></li>
<li class="chapter" data-level="8.6.2" data-path="conditions.html"><a href="conditions.html#try-success-failure"><i class="fa fa-check"></i><b>8.6.2</b> Success and failure values</a></li>
<li class="chapter" data-level="8.6.3" data-path="conditions.html"><a href="conditions.html#resignal"><i class="fa fa-check"></i><b>8.6.3</b> Resignal</a></li>
<li class="chapter" data-level="8.6.4" data-path="conditions.html"><a href="conditions.html#record"><i class="fa fa-check"></i><b>8.6.4</b> Record</a></li>
<li class="chapter" data-level="8.6.5" data-path="conditions.html"><a href="conditions.html#no-default-behaviour"><i class="fa fa-check"></i><b>8.6.5</b> No default behaviour</a></li>
<li class="chapter" data-level="8.6.6" data-path="conditions.html"><a href="conditions.html#exercises-27"><i class="fa fa-check"></i><b>8.6.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="conditions.html"><a href="conditions.html#conditions-answers"><i class="fa fa-check"></i><b>8.7</b> Quiz answers</a></li>
</ul></li>
<li class="part"><span><b>II Functional programming</b></span></li>
<li class="chapter" data-level="" data-path="fp.html"><a href="fp.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="fp.html"><a href="fp.html#functional-programming-languages"><i class="fa fa-check"></i>Functional programming languages</a></li>
<li class="chapter" data-level="" data-path="fp.html"><a href="fp.html#functional-style"><i class="fa fa-check"></i>Functional style</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="functionals.html"><a href="functionals.html"><i class="fa fa-check"></i><b>9</b> Functionals</a>
<ul>
<li class="chapter" data-level="9.1" data-path="functionals.html"><a href="functionals.html#introduction-8"><i class="fa fa-check"></i><b>9.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="functionals.html"><a href="functionals.html#outline-7"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="functionals.html"><a href="functionals.html#prerequisites-3"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="functionals.html"><a href="functionals.html#map"><i class="fa fa-check"></i><b>9.2</b> My first functional: <code>map()</code></a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="functionals.html"><a href="functionals.html#map-atomic"><i class="fa fa-check"></i><b>9.2.1</b> Producing atomic vectors</a></li>
<li class="chapter" data-level="9.2.2" data-path="functionals.html"><a href="functionals.html#purrr-shortcuts"><i class="fa fa-check"></i><b>9.2.2</b> Anonymous functions and shortcuts</a></li>
<li class="chapter" data-level="9.2.3" data-path="functionals.html"><a href="functionals.html#passing-arguments"><i class="fa fa-check"></i><b>9.2.3</b> Passing arguments with <code>...</code></a></li>
<li class="chapter" data-level="9.2.4" data-path="functionals.html"><a href="functionals.html#argument-names"><i class="fa fa-check"></i><b>9.2.4</b> Argument names</a></li>
<li class="chapter" data-level="9.2.5" data-path="functionals.html"><a href="functionals.html#change-argument"><i class="fa fa-check"></i><b>9.2.5</b> Varying another argument</a></li>
<li class="chapter" data-level="9.2.6" data-path="functionals.html"><a href="functionals.html#exercises-28"><i class="fa fa-check"></i><b>9.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="functionals.html"><a href="functionals.html#purrr-style"><i class="fa fa-check"></i><b>9.3</b> Purrr style</a></li>
<li class="chapter" data-level="9.4" data-path="functionals.html"><a href="functionals.html#map-variants"><i class="fa fa-check"></i><b>9.4</b> Map variants</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="functionals.html"><a href="functionals.html#modify"><i class="fa fa-check"></i><b>9.4.1</b> Same type of output as input: <code>modify()</code></a></li>
<li class="chapter" data-level="9.4.2" data-path="functionals.html"><a href="functionals.html#map2"><i class="fa fa-check"></i><b>9.4.2</b> Two inputs: <code>map2()</code> and friends</a></li>
<li class="chapter" data-level="9.4.3" data-path="functionals.html"><a href="functionals.html#no-outputs-walk-and-friends"><i class="fa fa-check"></i><b>9.4.3</b> No outputs: <code>walk()</code> and friends</a></li>
<li class="chapter" data-level="9.4.4" data-path="functionals.html"><a href="functionals.html#iterating-over-values-and-indices"><i class="fa fa-check"></i><b>9.4.4</b> Iterating over values and indices</a></li>
<li class="chapter" data-level="9.4.5" data-path="functionals.html"><a href="functionals.html#pmap"><i class="fa fa-check"></i><b>9.4.5</b> Any number of inputs: <code>pmap()</code> and friends</a></li>
<li class="chapter" data-level="9.4.6" data-path="functionals.html"><a href="functionals.html#exercises-29"><i class="fa fa-check"></i><b>9.4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="functionals.html"><a href="functionals.html#reduce"><i class="fa fa-check"></i><b>9.5</b> Reduce family</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="functionals.html"><a href="functionals.html#basics-1"><i class="fa fa-check"></i><b>9.5.1</b> Basics</a></li>
<li class="chapter" data-level="9.5.2" data-path="functionals.html"><a href="functionals.html#accumulate"><i class="fa fa-check"></i><b>9.5.2</b> Accumulate</a></li>
<li class="chapter" data-level="9.5.3" data-path="functionals.html"><a href="functionals.html#output-types"><i class="fa fa-check"></i><b>9.5.3</b> Output types</a></li>
<li class="chapter" data-level="9.5.4" data-path="functionals.html"><a href="functionals.html#multiple-inputs"><i class="fa fa-check"></i><b>9.5.4</b> Multiple inputs</a></li>
<li class="chapter" data-level="9.5.5" data-path="functionals.html"><a href="functionals.html#map-reduce"><i class="fa fa-check"></i><b>9.5.5</b> Map-reduce</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="functionals.html"><a href="functionals.html#predicate-functionals"><i class="fa fa-check"></i><b>9.6</b> Predicate functionals</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="functionals.html"><a href="functionals.html#basics-2"><i class="fa fa-check"></i><b>9.6.1</b> Basics</a></li>
<li class="chapter" data-level="9.6.2" data-path="functionals.html"><a href="functionals.html#predicate-map"><i class="fa fa-check"></i><b>9.6.2</b> Map variants</a></li>
<li class="chapter" data-level="9.6.3" data-path="functionals.html"><a href="functionals.html#exercises-30"><i class="fa fa-check"></i><b>9.6.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="functionals.html"><a href="functionals.html#base-functionals"><i class="fa fa-check"></i><b>9.7</b> Base functionals</a>
<ul>
<li class="chapter" data-level="9.7.1" data-path="functionals.html"><a href="functionals.html#matrices-and-arrays"><i class="fa fa-check"></i><b>9.7.1</b> Matrices and arrays</a></li>
<li class="chapter" data-level="9.7.2" data-path="functionals.html"><a href="functionals.html#mathematical-concerns"><i class="fa fa-check"></i><b>9.7.2</b> Mathematical concerns</a></li>
<li class="chapter" data-level="9.7.3" data-path="functionals.html"><a href="functionals.html#exercises-31"><i class="fa fa-check"></i><b>9.7.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="function-factories.html"><a href="function-factories.html"><i class="fa fa-check"></i><b>10</b> Function factories</a>
<ul>
<li class="chapter" data-level="10.1" data-path="function-factories.html"><a href="function-factories.html#introduction-9"><i class="fa fa-check"></i><b>10.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="function-factories.html"><a href="function-factories.html#outline-8"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="function-factories.html"><a href="function-factories.html#prerequisites-4"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="function-factories.html"><a href="function-factories.html#factory-fundamentals"><i class="fa fa-check"></i><b>10.2</b> Factory fundamentals</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="function-factories.html"><a href="function-factories.html#environments-1"><i class="fa fa-check"></i><b>10.2.1</b> Environments</a></li>
<li class="chapter" data-level="10.2.2" data-path="function-factories.html"><a href="function-factories.html#diagram-conventions"><i class="fa fa-check"></i><b>10.2.2</b> Diagram conventions</a></li>
<li class="chapter" data-level="10.2.3" data-path="function-factories.html"><a href="function-factories.html#forcing-evaluation"><i class="fa fa-check"></i><b>10.2.3</b> Forcing evaluation</a></li>
<li class="chapter" data-level="10.2.4" data-path="function-factories.html"><a href="function-factories.html#stateful-funs"><i class="fa fa-check"></i><b>10.2.4</b> Stateful functions</a></li>
<li class="chapter" data-level="10.2.5" data-path="function-factories.html"><a href="function-factories.html#factory-pitfalls"><i class="fa fa-check"></i><b>10.2.5</b> Garbage collection</a></li>
<li class="chapter" data-level="10.2.6" data-path="function-factories.html"><a href="function-factories.html#exercises-32"><i class="fa fa-check"></i><b>10.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="function-factories.html"><a href="function-factories.html#graph-fact"><i class="fa fa-check"></i><b>10.3</b> Graphical factories</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="function-factories.html"><a href="function-factories.html#labelling"><i class="fa fa-check"></i><b>10.3.1</b> Labelling</a></li>
<li class="chapter" data-level="10.3.2" data-path="function-factories.html"><a href="function-factories.html#histogram-bins"><i class="fa fa-check"></i><b>10.3.2</b> Histogram bins</a></li>
<li class="chapter" data-level="10.3.3" data-path="function-factories.html"><a href="function-factories.html#ggsave"><i class="fa fa-check"></i><b>10.3.3</b> <code>ggsave()</code></a></li>
<li class="chapter" data-level="10.3.4" data-path="function-factories.html"><a href="function-factories.html#exercises-33"><i class="fa fa-check"></i><b>10.3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="function-factories.html"><a href="function-factories.html#stat-fact"><i class="fa fa-check"></i><b>10.4</b> Statistical factories</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="function-factories.html"><a href="function-factories.html#box-cox-transformation"><i class="fa fa-check"></i><b>10.4.1</b> Box-Cox transformation</a></li>
<li class="chapter" data-level="10.4.2" data-path="function-factories.html"><a href="function-factories.html#bootstrap-generators"><i class="fa fa-check"></i><b>10.4.2</b> Bootstrap generators</a></li>
<li class="chapter" data-level="10.4.3" data-path="function-factories.html"><a href="function-factories.html#MLE"><i class="fa fa-check"></i><b>10.4.3</b> Maximum likelihood estimation</a></li>
<li class="chapter" data-level="10.4.4" data-path="function-factories.html"><a href="function-factories.html#exercises-34"><i class="fa fa-check"></i><b>10.4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="function-factories.html"><a href="function-factories.html#functional-factories"><i class="fa fa-check"></i><b>10.5</b> Function factories + functionals</a>
<ul>
<li class="chapter" data-level="10.5.1" data-path="function-factories.html"><a href="function-factories.html#exercises-35"><i class="fa fa-check"></i><b>10.5.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="function-operators.html"><a href="function-operators.html"><i class="fa fa-check"></i><b>11</b> Function operators</a>
<ul>
<li class="chapter" data-level="11.1" data-path="function-operators.html"><a href="function-operators.html#introduction-10"><i class="fa fa-check"></i><b>11.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="function-operators.html"><a href="function-operators.html#outline-9"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="function-operators.html"><a href="function-operators.html#prerequisites-5"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="function-operators.html"><a href="function-operators.html#existing-fos"><i class="fa fa-check"></i><b>11.2</b> Existing function operators</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="function-operators.html"><a href="function-operators.html#safely"><i class="fa fa-check"></i><b>11.2.1</b> Capturing errors with <code>purrr::safely()</code></a></li>
<li class="chapter" data-level="11.2.2" data-path="function-operators.html"><a href="function-operators.html#memoise"><i class="fa fa-check"></i><b>11.2.2</b> Caching computations with <code>memoise::memoise()</code></a></li>
<li class="chapter" data-level="11.2.3" data-path="function-operators.html"><a href="function-operators.html#exercises-36"><i class="fa fa-check"></i><b>11.2.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="function-operators.html"><a href="function-operators.html#fo-case-study"><i class="fa fa-check"></i><b>11.3</b> Case study: Creating your own function operators</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="function-operators.html"><a href="function-operators.html#exercises-37"><i class="fa fa-check"></i><b>11.3.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Object-oriented programming</b></span></li>
<li class="chapter" data-level="" data-path="oo.html"><a href="oo.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="oo.html"><a href="oo.html#oop-systems"><i class="fa fa-check"></i>OOP systems</a></li>
<li class="chapter" data-level="" data-path="oo.html"><a href="oo.html#oop-in-r"><i class="fa fa-check"></i>OOP in R</a></li>
<li class="chapter" data-level="" data-path="oo.html"><a href="oo.html#sloop"><i class="fa fa-check"></i>sloop</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="base-types.html"><a href="base-types.html"><i class="fa fa-check"></i><b>12</b> Base types</a>
<ul>
<li class="chapter" data-level="12.1" data-path="base-types.html"><a href="base-types.html#introduction-11"><i class="fa fa-check"></i><b>12.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="base-types.html"><a href="base-types.html#outline-10"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="base-types.html"><a href="base-types.html#base-vs-oo"><i class="fa fa-check"></i><b>12.2</b> Base versus OO objects</a></li>
<li class="chapter" data-level="12.3" data-path="base-types.html"><a href="base-types.html#base-types-2"><i class="fa fa-check"></i><b>12.3</b> Base types</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="base-types.html"><a href="base-types.html#numeric-type"><i class="fa fa-check"></i><b>12.3.1</b> Numeric type</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="s3.html"><a href="s3.html"><i class="fa fa-check"></i><b>13</b> S3</a>
<ul>
<li class="chapter" data-level="13.1" data-path="s3.html"><a href="s3.html#introduction-12"><i class="fa fa-check"></i><b>13.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#outline-11"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#prerequisites-6"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="s3.html"><a href="s3.html#s3-basics"><i class="fa fa-check"></i><b>13.2</b> Basics</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="s3.html"><a href="s3.html#exercises-38"><i class="fa fa-check"></i><b>13.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="s3.html"><a href="s3.html#s3-classes"><i class="fa fa-check"></i><b>13.3</b> Classes</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="s3.html"><a href="s3.html#s3-constructor"><i class="fa fa-check"></i><b>13.3.1</b> Constructors</a></li>
<li class="chapter" data-level="13.3.2" data-path="s3.html"><a href="s3.html#validators"><i class="fa fa-check"></i><b>13.3.2</b> Validators</a></li>
<li class="chapter" data-level="13.3.3" data-path="s3.html"><a href="s3.html#helpers"><i class="fa fa-check"></i><b>13.3.3</b> Helpers</a></li>
<li class="chapter" data-level="13.3.4" data-path="s3.html"><a href="s3.html#exercises-39"><i class="fa fa-check"></i><b>13.3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="s3.html"><a href="s3.html#s3-methods"><i class="fa fa-check"></i><b>13.4</b> Generics and methods</a>
<ul>
<li class="chapter" data-level="13.4.1" data-path="s3.html"><a href="s3.html#method-dispatch"><i class="fa fa-check"></i><b>13.4.1</b> Method dispatch</a></li>
<li class="chapter" data-level="13.4.2" data-path="s3.html"><a href="s3.html#finding-methods"><i class="fa fa-check"></i><b>13.4.2</b> Finding methods</a></li>
<li class="chapter" data-level="13.4.3" data-path="s3.html"><a href="s3.html#s3-arguments"><i class="fa fa-check"></i><b>13.4.3</b> Creating methods</a></li>
<li class="chapter" data-level="13.4.4" data-path="s3.html"><a href="s3.html#exercises-40"><i class="fa fa-check"></i><b>13.4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13.5" data-path="s3.html"><a href="s3.html#object-styles"><i class="fa fa-check"></i><b>13.5</b> Object styles</a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="s3.html"><a href="s3.html#exercises-41"><i class="fa fa-check"></i><b>13.5.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="s3.html"><a href="s3.html#s3-inheritance"><i class="fa fa-check"></i><b>13.6</b> Inheritance</a>
<ul>
<li class="chapter" data-level="13.6.1" data-path="s3.html"><a href="s3.html#nextmethod"><i class="fa fa-check"></i><b>13.6.1</b> <code>NextMethod()</code></a></li>
<li class="chapter" data-level="13.6.2" data-path="s3.html"><a href="s3.html#s3-subclassing"><i class="fa fa-check"></i><b>13.6.2</b> Allowing subclassing</a></li>
<li class="chapter" data-level="13.6.3" data-path="s3.html"><a href="s3.html#exercises-42"><i class="fa fa-check"></i><b>13.6.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13.7" data-path="s3.html"><a href="s3.html#s3-dispatch"><i class="fa fa-check"></i><b>13.7</b> Dispatch details</a>
<ul>
<li class="chapter" data-level="13.7.1" data-path="s3.html"><a href="s3.html#implicit-class"><i class="fa fa-check"></i><b>13.7.1</b> S3 and base types</a></li>
<li class="chapter" data-level="13.7.2" data-path="s3.html"><a href="s3.html#internal-generics"><i class="fa fa-check"></i><b>13.7.2</b> Internal generics</a></li>
<li class="chapter" data-level="13.7.3" data-path="s3.html"><a href="s3.html#group-generics"><i class="fa fa-check"></i><b>13.7.3</b> Group generics</a></li>
<li class="chapter" data-level="13.7.4" data-path="s3.html"><a href="s3.html#double-dispatch"><i class="fa fa-check"></i><b>13.7.4</b> Double dispatch</a></li>
<li class="chapter" data-level="13.7.5" data-path="s3.html"><a href="s3.html#exercises-43"><i class="fa fa-check"></i><b>13.7.5</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="r6.html"><a href="r6.html"><i class="fa fa-check"></i><b>14</b> R6</a>
<ul>
<li class="chapter" data-level="14.1" data-path="r6.html"><a href="r6.html#introduction-13"><i class="fa fa-check"></i><b>14.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="r6.html"><a href="r6.html#outline-12"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="r6.html"><a href="r6.html#prerequisites-7"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="r6.html"><a href="r6.html#r6-classes"><i class="fa fa-check"></i><b>14.2</b> Classes and methods</a>
<ul>
<li class="chapter" data-level="14.2.1" data-path="r6.html"><a href="r6.html#method-chaining"><i class="fa fa-check"></i><b>14.2.1</b> Method chaining</a></li>
<li class="chapter" data-level="14.2.2" data-path="r6.html"><a href="r6.html#r6-important-methods"><i class="fa fa-check"></i><b>14.2.2</b> Important methods</a></li>
<li class="chapter" data-level="14.2.3" data-path="r6.html"><a href="r6.html#adding-methods-after-creation"><i class="fa fa-check"></i><b>14.2.3</b> Adding methods after creation</a></li>
<li class="chapter" data-level="14.2.4" data-path="r6.html"><a href="r6.html#inheritance"><i class="fa fa-check"></i><b>14.2.4</b> Inheritance</a></li>
<li class="chapter" data-level="14.2.5" data-path="r6.html"><a href="r6.html#introspection"><i class="fa fa-check"></i><b>14.2.5</b> Introspection</a></li>
<li class="chapter" data-level="14.2.6" data-path="r6.html"><a href="r6.html#exercises-44"><i class="fa fa-check"></i><b>14.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="r6.html"><a href="r6.html#r6-access"><i class="fa fa-check"></i><b>14.3</b> Controlling access</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="r6.html"><a href="r6.html#privacy"><i class="fa fa-check"></i><b>14.3.1</b> Privacy</a></li>
<li class="chapter" data-level="14.3.2" data-path="r6.html"><a href="r6.html#active-fields"><i class="fa fa-check"></i><b>14.3.2</b> Active fields</a></li>
<li class="chapter" data-level="14.3.3" data-path="r6.html"><a href="r6.html#exercises-45"><i class="fa fa-check"></i><b>14.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="r6.html"><a href="r6.html#r6-semantics"><i class="fa fa-check"></i><b>14.4</b> Reference semantics</a>
<ul>
<li class="chapter" data-level="14.4.1" data-path="r6.html"><a href="r6.html#reasoning"><i class="fa fa-check"></i><b>14.4.1</b> Reasoning</a></li>
<li class="chapter" data-level="14.4.2" data-path="r6.html"><a href="r6.html#finalizer"><i class="fa fa-check"></i><b>14.4.2</b> Finalizer</a></li>
<li class="chapter" data-level="14.4.3" data-path="r6.html"><a href="r6.html#r6-fields"><i class="fa fa-check"></i><b>14.4.3</b> R6 fields</a></li>
<li class="chapter" data-level="14.4.4" data-path="r6.html"><a href="r6.html#exercises-46"><i class="fa fa-check"></i><b>14.4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14.5" data-path="r6.html"><a href="r6.html#why-r6"><i class="fa fa-check"></i><b>14.5</b> Why R6?</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="s4.html"><a href="s4.html"><i class="fa fa-check"></i><b>15</b> S4</a>
<ul>
<li class="chapter" data-level="15.1" data-path="s4.html"><a href="s4.html#introduction-14"><i class="fa fa-check"></i><b>15.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="s4.html"><a href="s4.html#outline-13"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="s4.html"><a href="s4.html#learning-more"><i class="fa fa-check"></i>Learning more</a></li>
<li class="chapter" data-level="" data-path="s4.html"><a href="s4.html#prerequisites-8"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="s4.html"><a href="s4.html#s4-basics"><i class="fa fa-check"></i><b>15.2</b> Basics</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="s4.html"><a href="s4.html#exercises-47"><i class="fa fa-check"></i><b>15.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="s4.html"><a href="s4.html#s4-classes"><i class="fa fa-check"></i><b>15.3</b> Classes</a>
<ul>
<li class="chapter" data-level="15.3.1" data-path="s4.html"><a href="s4.html#inheritance-1"><i class="fa fa-check"></i><b>15.3.1</b> Inheritance</a></li>
<li class="chapter" data-level="15.3.2" data-path="s4.html"><a href="s4.html#introspection-1"><i class="fa fa-check"></i><b>15.3.2</b> Introspection</a></li>
<li class="chapter" data-level="15.3.3" data-path="s4.html"><a href="s4.html#redefinition"><i class="fa fa-check"></i><b>15.3.3</b> Redefinition</a></li>
<li class="chapter" data-level="15.3.4" data-path="s4.html"><a href="s4.html#helper"><i class="fa fa-check"></i><b>15.3.4</b> Helper</a></li>
<li class="chapter" data-level="15.3.5" data-path="s4.html"><a href="s4.html#validator"><i class="fa fa-check"></i><b>15.3.5</b> Validator</a></li>
<li class="chapter" data-level="15.3.6" data-path="s4.html"><a href="s4.html#exercises-48"><i class="fa fa-check"></i><b>15.3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15.4" data-path="s4.html"><a href="s4.html#s4-generics"><i class="fa fa-check"></i><b>15.4</b> Generics and methods</a>
<ul>
<li class="chapter" data-level="15.4.1" data-path="s4.html"><a href="s4.html#signature"><i class="fa fa-check"></i><b>15.4.1</b> Signature</a></li>
<li class="chapter" data-level="15.4.2" data-path="s4.html"><a href="s4.html#methods"><i class="fa fa-check"></i><b>15.4.2</b> Methods</a></li>
<li class="chapter" data-level="15.4.3" data-path="s4.html"><a href="s4.html#show-method"><i class="fa fa-check"></i><b>15.4.3</b> Show method</a></li>
<li class="chapter" data-level="15.4.4" data-path="s4.html"><a href="s4.html#accessors"><i class="fa fa-check"></i><b>15.4.4</b> Accessors</a></li>
<li class="chapter" data-level="15.4.5" data-path="s4.html"><a href="s4.html#exercises-49"><i class="fa fa-check"></i><b>15.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15.5" data-path="s4.html"><a href="s4.html#s4-dispatch"><i class="fa fa-check"></i><b>15.5</b> Method dispatch</a>
<ul>
<li class="chapter" data-level="15.5.1" data-path="s4.html"><a href="s4.html#single-dispatch"><i class="fa fa-check"></i><b>15.5.1</b> Single dispatch</a></li>
<li class="chapter" data-level="15.5.2" data-path="s4.html"><a href="s4.html#multiple-inheritance"><i class="fa fa-check"></i><b>15.5.2</b> Multiple inheritance</a></li>
<li class="chapter" data-level="15.5.3" data-path="s4.html"><a href="s4.html#multiple-dispatch"><i class="fa fa-check"></i><b>15.5.3</b> Multiple dispatch</a></li>
<li class="chapter" data-level="15.5.4" data-path="s4.html"><a href="s4.html#multiple-dispatch-and-multiple-inheritance"><i class="fa fa-check"></i><b>15.5.4</b> Multiple dispatch and multiple inheritance</a></li>
<li class="chapter" data-level="15.5.5" data-path="s4.html"><a href="s4.html#exercises-50"><i class="fa fa-check"></i><b>15.5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15.6" data-path="s4.html"><a href="s4.html#s4-s3"><i class="fa fa-check"></i><b>15.6</b> S4 and S3</a>
<ul>
<li class="chapter" data-level="15.6.1" data-path="s4.html"><a href="s4.html#classes"><i class="fa fa-check"></i><b>15.6.1</b> Classes</a></li>
<li class="chapter" data-level="15.6.2" data-path="s4.html"><a href="s4.html#generics"><i class="fa fa-check"></i><b>15.6.2</b> Generics</a></li>
<li class="chapter" data-level="15.6.3" data-path="s4.html"><a href="s4.html#exercises-51"><i class="fa fa-check"></i><b>15.6.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html"><i class="fa fa-check"></i><b>16</b> Trade-offs</a>
<ul>
<li class="chapter" data-level="16.1" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#introduction-15"><i class="fa fa-check"></i><b>16.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#outline-14"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#prerequisites-9"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#s3-s4"><i class="fa fa-check"></i><b>16.2</b> S4 versus S3</a></li>
<li class="chapter" data-level="16.3" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#s3-r6"><i class="fa fa-check"></i><b>16.3</b> R6 versus S3</a>
<ul>
<li class="chapter" data-level="16.3.1" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#namespacing"><i class="fa fa-check"></i><b>16.3.1</b> Namespacing</a></li>
<li class="chapter" data-level="16.3.2" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#threading-state"><i class="fa fa-check"></i><b>16.3.2</b> Threading state</a></li>
<li class="chapter" data-level="16.3.3" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#tradeoffs-pipe"><i class="fa fa-check"></i><b>16.3.3</b> Method chaining</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>IV Metaprogramming</b></span></li>
<li class="chapter" data-level="" data-path="metaprogramming.html"><a href="metaprogramming.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="17" data-path="meta-big-picture.html"><a href="meta-big-picture.html"><i class="fa fa-check"></i><b>17</b> Big picture</a>
<ul>
<li class="chapter" data-level="17.1" data-path="meta-big-picture.html"><a href="meta-big-picture.html#introduction-16"><i class="fa fa-check"></i><b>17.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="meta-big-picture.html"><a href="meta-big-picture.html#outline-15"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="meta-big-picture.html"><a href="meta-big-picture.html#prerequisites-10"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="meta-big-picture.html"><a href="meta-big-picture.html#code-data"><i class="fa fa-check"></i><b>17.2</b> Code is data</a></li>
<li class="chapter" data-level="17.3" data-path="meta-big-picture.html"><a href="meta-big-picture.html#code-tree"><i class="fa fa-check"></i><b>17.3</b> Code is a tree</a></li>
<li class="chapter" data-level="17.4" data-path="meta-big-picture.html"><a href="meta-big-picture.html#coding-code"><i class="fa fa-check"></i><b>17.4</b> Code can generate code</a></li>
<li class="chapter" data-level="17.5" data-path="meta-big-picture.html"><a href="meta-big-picture.html#eval-intro"><i class="fa fa-check"></i><b>17.5</b> Evaluation runs code</a></li>
<li class="chapter" data-level="17.6" data-path="meta-big-picture.html"><a href="meta-big-picture.html#eval-funs"><i class="fa fa-check"></i><b>17.6</b> Customising evaluation with functions</a></li>
<li class="chapter" data-level="17.7" data-path="meta-big-picture.html"><a href="meta-big-picture.html#eval-data"><i class="fa fa-check"></i><b>17.7</b> Customising evaluation with data</a></li>
<li class="chapter" data-level="17.8" data-path="meta-big-picture.html"><a href="meta-big-picture.html#quosure-intro"><i class="fa fa-check"></i><b>17.8</b> Quosures</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="expressions.html"><a href="expressions.html"><i class="fa fa-check"></i><b>18</b> Expressions</a>
<ul>
<li class="chapter" data-level="18.1" data-path="expressions.html"><a href="expressions.html#introduction-17"><i class="fa fa-check"></i><b>18.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="expressions.html"><a href="expressions.html#outline-16"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="expressions.html"><a href="expressions.html#prerequisites-11"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="18.2" data-path="expressions.html"><a href="expressions.html#ast"><i class="fa fa-check"></i><b>18.2</b> Abstract syntax trees</a>
<ul>
<li class="chapter" data-level="18.2.1" data-path="expressions.html"><a href="expressions.html#drawing"><i class="fa fa-check"></i><b>18.2.1</b> Drawing</a></li>
<li class="chapter" data-level="18.2.2" data-path="expressions.html"><a href="expressions.html#non-code-components"><i class="fa fa-check"></i><b>18.2.2</b> Non-code components</a></li>
<li class="chapter" data-level="18.2.3" data-path="expressions.html"><a href="expressions.html#infix-calls"><i class="fa fa-check"></i><b>18.2.3</b> Infix calls</a></li>
<li class="chapter" data-level="18.2.4" data-path="expressions.html"><a href="expressions.html#exercises-52"><i class="fa fa-check"></i><b>18.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18.3" data-path="expressions.html"><a href="expressions.html#expression-details"><i class="fa fa-check"></i><b>18.3</b> Expressions</a>
<ul>
<li class="chapter" data-level="18.3.1" data-path="expressions.html"><a href="expressions.html#constants"><i class="fa fa-check"></i><b>18.3.1</b> Constants</a></li>
<li class="chapter" data-level="18.3.2" data-path="expressions.html"><a href="expressions.html#symbols"><i class="fa fa-check"></i><b>18.3.2</b> Symbols</a></li>
<li class="chapter" data-level="18.3.3" data-path="expressions.html"><a href="expressions.html#calls"><i class="fa fa-check"></i><b>18.3.3</b> Calls</a></li>
<li class="chapter" data-level="18.3.4" data-path="expressions.html"><a href="expressions.html#summary"><i class="fa fa-check"></i><b>18.3.4</b> Summary</a></li>
<li class="chapter" data-level="18.3.5" data-path="expressions.html"><a href="expressions.html#exercises-53"><i class="fa fa-check"></i><b>18.3.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18.4" data-path="expressions.html"><a href="expressions.html#grammar"><i class="fa fa-check"></i><b>18.4</b> Parsing and grammar</a>
<ul>
<li class="chapter" data-level="18.4.1" data-path="expressions.html"><a href="expressions.html#operator-precedence"><i class="fa fa-check"></i><b>18.4.1</b> Operator precedence</a></li>
<li class="chapter" data-level="18.4.2" data-path="expressions.html"><a href="expressions.html#associativity"><i class="fa fa-check"></i><b>18.4.2</b> Associativity</a></li>
<li class="chapter" data-level="18.4.3" data-path="expressions.html"><a href="expressions.html#parsing"><i class="fa fa-check"></i><b>18.4.3</b> Parsing and deparsing</a></li>
<li class="chapter" data-level="18.4.4" data-path="expressions.html"><a href="expressions.html#exercises-54"><i class="fa fa-check"></i><b>18.4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18.5" data-path="expressions.html"><a href="expressions.html#ast-funs"><i class="fa fa-check"></i><b>18.5</b> Walking AST with recursive functions</a>
<ul>
<li class="chapter" data-level="18.5.1" data-path="expressions.html"><a href="expressions.html#finding-f-and-t"><i class="fa fa-check"></i><b>18.5.1</b> Finding F and T</a></li>
<li class="chapter" data-level="18.5.2" data-path="expressions.html"><a href="expressions.html#finding-all-variables-created-by-assignment"><i class="fa fa-check"></i><b>18.5.2</b> Finding all variables created by assignment</a></li>
<li class="chapter" data-level="18.5.3" data-path="expressions.html"><a href="expressions.html#exercises-55"><i class="fa fa-check"></i><b>18.5.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18.6" data-path="expressions.html"><a href="expressions.html#expression-special"><i class="fa fa-check"></i><b>18.6</b> Specialised data structures</a>
<ul>
<li class="chapter" data-level="18.6.1" data-path="expressions.html"><a href="expressions.html#pairlists"><i class="fa fa-check"></i><b>18.6.1</b> Pairlists</a></li>
<li class="chapter" data-level="18.6.2" data-path="expressions.html"><a href="expressions.html#empty-symbol"><i class="fa fa-check"></i><b>18.6.2</b> Missing arguments</a></li>
<li class="chapter" data-level="18.6.3" data-path="expressions.html"><a href="expressions.html#expression-vectors"><i class="fa fa-check"></i><b>18.6.3</b> Expression vectors</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="19" data-path="quasiquotation.html"><a href="quasiquotation.html"><i class="fa fa-check"></i><b>19</b> Quasiquotation</a>
<ul>
<li class="chapter" data-level="19.1" data-path="quasiquotation.html"><a href="quasiquotation.html#introduction-18"><i class="fa fa-check"></i><b>19.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#outline-17"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#prerequisites-12"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#related-work"><i class="fa fa-check"></i>Related work</a></li>
</ul></li>
<li class="chapter" data-level="19.2" data-path="quasiquotation.html"><a href="quasiquotation.html#quasi-motivation"><i class="fa fa-check"></i><b>19.2</b> Motivation</a>
<ul>
<li class="chapter" data-level="19.2.1" data-path="quasiquotation.html"><a href="quasiquotation.html#vocabulary"><i class="fa fa-check"></i><b>19.2.1</b> Vocabulary</a></li>
<li class="chapter" data-level="19.2.2" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-56"><i class="fa fa-check"></i><b>19.2.2</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19.3" data-path="quasiquotation.html"><a href="quasiquotation.html#quoting"><i class="fa fa-check"></i><b>19.3</b> Quoting</a>
<ul>
<li class="chapter" data-level="19.3.1" data-path="quasiquotation.html"><a href="quasiquotation.html#capturing-expressions"><i class="fa fa-check"></i><b>19.3.1</b> Capturing expressions</a></li>
<li class="chapter" data-level="19.3.2" data-path="quasiquotation.html"><a href="quasiquotation.html#capturing-symbols"><i class="fa fa-check"></i><b>19.3.2</b> Capturing symbols</a></li>
<li class="chapter" data-level="19.3.3" data-path="quasiquotation.html"><a href="quasiquotation.html#with-base-r"><i class="fa fa-check"></i><b>19.3.3</b> With base R</a></li>
<li class="chapter" data-level="19.3.4" data-path="quasiquotation.html"><a href="quasiquotation.html#substitution"><i class="fa fa-check"></i><b>19.3.4</b> Substitution</a></li>
<li class="chapter" data-level="19.3.5" data-path="quasiquotation.html"><a href="quasiquotation.html#summary-1"><i class="fa fa-check"></i><b>19.3.5</b> Summary</a></li>
<li class="chapter" data-level="19.3.6" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-57"><i class="fa fa-check"></i><b>19.3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19.4" data-path="quasiquotation.html"><a href="quasiquotation.html#unquoting"><i class="fa fa-check"></i><b>19.4</b> Unquoting</a>
<ul>
<li class="chapter" data-level="19.4.1" data-path="quasiquotation.html"><a href="quasiquotation.html#unquoting-one-argument"><i class="fa fa-check"></i><b>19.4.1</b> Unquoting one argument</a></li>
<li class="chapter" data-level="19.4.2" data-path="quasiquotation.html"><a href="quasiquotation.html#unquoting-a-function"><i class="fa fa-check"></i><b>19.4.2</b> Unquoting a function</a></li>
<li class="chapter" data-level="19.4.3" data-path="quasiquotation.html"><a href="quasiquotation.html#unquote-missing"><i class="fa fa-check"></i><b>19.4.3</b> Unquoting a missing argument</a></li>
<li class="chapter" data-level="19.4.4" data-path="quasiquotation.html"><a href="quasiquotation.html#unquoting-in-special-forms"><i class="fa fa-check"></i><b>19.4.4</b> Unquoting in special forms</a></li>
<li class="chapter" data-level="19.4.5" data-path="quasiquotation.html"><a href="quasiquotation.html#unquoting-many-arguments"><i class="fa fa-check"></i><b>19.4.5</b> Unquoting many arguments</a></li>
<li class="chapter" data-level="19.4.6" data-path="quasiquotation.html"><a href="quasiquotation.html#the-polite-fiction-of"><i class="fa fa-check"></i><b>19.4.6</b> The polite fiction of <code>!!</code></a></li>
<li class="chapter" data-level="19.4.7" data-path="quasiquotation.html"><a href="quasiquotation.html#non-standard-ast"><i class="fa fa-check"></i><b>19.4.7</b> Non-standard ASTs</a></li>
<li class="chapter" data-level="19.4.8" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-58"><i class="fa fa-check"></i><b>19.4.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19.5" data-path="quasiquotation.html"><a href="quasiquotation.html#base-nonquote"><i class="fa fa-check"></i><b>19.5</b> Non-quoting</a></li>
<li class="chapter" data-level="19.6" data-path="quasiquotation.html"><a href="quasiquotation.html#tidy-dots"><i class="fa fa-check"></i><b>19.6</b> <code>...</code> (dot-dot-dot)</a>
<ul>
<li class="chapter" data-level="19.6.1" data-path="quasiquotation.html"><a href="quasiquotation.html#examples"><i class="fa fa-check"></i><b>19.6.1</b> Examples</a></li>
<li class="chapter" data-level="19.6.2" data-path="quasiquotation.html"><a href="quasiquotation.html#exec"><i class="fa fa-check"></i><b>19.6.2</b> <code>exec()</code></a></li>
<li class="chapter" data-level="19.6.3" data-path="quasiquotation.html"><a href="quasiquotation.html#dots_list"><i class="fa fa-check"></i><b>19.6.3</b> <code>dots_list()</code></a></li>
<li class="chapter" data-level="19.6.4" data-path="quasiquotation.html"><a href="quasiquotation.html#do-call"><i class="fa fa-check"></i><b>19.6.4</b> With base R</a></li>
<li class="chapter" data-level="19.6.5" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-59"><i class="fa fa-check"></i><b>19.6.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19.7" data-path="quasiquotation.html"><a href="quasiquotation.html#expr-case-studies"><i class="fa fa-check"></i><b>19.7</b> Case studies</a>
<ul>
<li class="chapter" data-level="19.7.1" data-path="quasiquotation.html"><a href="quasiquotation.html#lobstrast"><i class="fa fa-check"></i><b>19.7.1</b> <code>lobstr::ast()</code></a></li>
<li class="chapter" data-level="19.7.2" data-path="quasiquotation.html"><a href="quasiquotation.html#map-reduce-to-generate-code"><i class="fa fa-check"></i><b>19.7.2</b> Map-reduce to generate code</a></li>
<li class="chapter" data-level="19.7.3" data-path="quasiquotation.html"><a href="quasiquotation.html#slicing-an-array"><i class="fa fa-check"></i><b>19.7.3</b> Slicing an array</a></li>
<li class="chapter" data-level="19.7.4" data-path="quasiquotation.html"><a href="quasiquotation.html#new-function"><i class="fa fa-check"></i><b>19.7.4</b> Creating functions</a></li>
<li class="chapter" data-level="19.7.5" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-60"><i class="fa fa-check"></i><b>19.7.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19.8" data-path="quasiquotation.html"><a href="quasiquotation.html#history"><i class="fa fa-check"></i><b>19.8</b> History</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="evaluation.html"><a href="evaluation.html"><i class="fa fa-check"></i><b>20</b> Evaluation</a>
<ul>
<li class="chapter" data-level="20.1" data-path="evaluation.html"><a href="evaluation.html#introduction-19"><i class="fa fa-check"></i><b>20.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="evaluation.html"><a href="evaluation.html#outline-18"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="evaluation.html"><a href="evaluation.html#prerequisites-13"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="20.2" data-path="evaluation.html"><a href="evaluation.html#eval"><i class="fa fa-check"></i><b>20.2</b> Evaluation basics</a>
<ul>
<li class="chapter" data-level="20.2.1" data-path="evaluation.html"><a href="evaluation.html#application-local"><i class="fa fa-check"></i><b>20.2.1</b> Application: <code>local()</code></a></li>
<li class="chapter" data-level="20.2.2" data-path="evaluation.html"><a href="evaluation.html#application-source"><i class="fa fa-check"></i><b>20.2.2</b> Application: <code>source()</code></a></li>
<li class="chapter" data-level="20.2.3" data-path="evaluation.html"><a href="evaluation.html#gotcha-function"><i class="fa fa-check"></i><b>20.2.3</b> Gotcha: <code>function()</code></a></li>
<li class="chapter" data-level="20.2.4" data-path="evaluation.html"><a href="evaluation.html#exercises-61"><i class="fa fa-check"></i><b>20.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="20.3" data-path="evaluation.html"><a href="evaluation.html#quosures"><i class="fa fa-check"></i><b>20.3</b> Quosures</a>
<ul>
<li class="chapter" data-level="20.3.1" data-path="evaluation.html"><a href="evaluation.html#creating"><i class="fa fa-check"></i><b>20.3.1</b> Creating</a></li>
<li class="chapter" data-level="20.3.2" data-path="evaluation.html"><a href="evaluation.html#evaluating"><i class="fa fa-check"></i><b>20.3.2</b> Evaluating</a></li>
<li class="chapter" data-level="20.3.3" data-path="evaluation.html"><a href="evaluation.html#quosure-dots"><i class="fa fa-check"></i><b>20.3.3</b> Dots</a></li>
<li class="chapter" data-level="20.3.4" data-path="evaluation.html"><a href="evaluation.html#quosure-impl"><i class="fa fa-check"></i><b>20.3.4</b> Under the hood</a></li>
<li class="chapter" data-level="20.3.5" data-path="evaluation.html"><a href="evaluation.html#nested-quosures"><i class="fa fa-check"></i><b>20.3.5</b> Nested quosures</a></li>
<li class="chapter" data-level="20.3.6" data-path="evaluation.html"><a href="evaluation.html#exercises-62"><i class="fa fa-check"></i><b>20.3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="evaluation.html"><a href="evaluation.html#data-masks"><i class="fa fa-check"></i><b>20.4</b> Data masks</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="evaluation.html"><a href="evaluation.html#basics-3"><i class="fa fa-check"></i><b>20.4.1</b> Basics</a></li>
<li class="chapter" data-level="20.4.2" data-path="evaluation.html"><a href="evaluation.html#pronouns"><i class="fa fa-check"></i><b>20.4.2</b> Pronouns</a></li>
<li class="chapter" data-level="20.4.3" data-path="evaluation.html"><a href="evaluation.html#subset"><i class="fa fa-check"></i><b>20.4.3</b> Application: <code>subset()</code></a></li>
<li class="chapter" data-level="20.4.4" data-path="evaluation.html"><a href="evaluation.html#application-transform"><i class="fa fa-check"></i><b>20.4.4</b> Application: transform</a></li>
<li class="chapter" data-level="20.4.5" data-path="evaluation.html"><a href="evaluation.html#select"><i class="fa fa-check"></i><b>20.4.5</b> Application: <code>select()</code></a></li>
<li class="chapter" data-level="20.4.6" data-path="evaluation.html"><a href="evaluation.html#exercises-63"><i class="fa fa-check"></i><b>20.4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="20.5" data-path="evaluation.html"><a href="evaluation.html#tidy-evaluation"><i class="fa fa-check"></i><b>20.5</b> Using tidy evaluation</a>
<ul>
<li class="chapter" data-level="20.5.1" data-path="evaluation.html"><a href="evaluation.html#quoting-and-unquoting"><i class="fa fa-check"></i><b>20.5.1</b> Quoting and unquoting</a></li>
<li class="chapter" data-level="20.5.2" data-path="evaluation.html"><a href="evaluation.html#handling-ambiguity"><i class="fa fa-check"></i><b>20.5.2</b> Handling ambiguity</a></li>
<li class="chapter" data-level="20.5.3" data-path="evaluation.html"><a href="evaluation.html#quoting-and-ambiguity"><i class="fa fa-check"></i><b>20.5.3</b> Quoting and ambiguity</a></li>
<li class="chapter" data-level="20.5.4" data-path="evaluation.html"><a href="evaluation.html#exercises-64"><i class="fa fa-check"></i><b>20.5.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="20.6" data-path="evaluation.html"><a href="evaluation.html#base-evaluation"><i class="fa fa-check"></i><b>20.6</b> Base evaluation</a>
<ul>
<li class="chapter" data-level="20.6.1" data-path="evaluation.html"><a href="evaluation.html#substitute"><i class="fa fa-check"></i><b>20.6.1</b> <code>substitute()</code></a></li>
<li class="chapter" data-level="20.6.2" data-path="evaluation.html"><a href="evaluation.html#match.call"><i class="fa fa-check"></i><b>20.6.2</b> <code>match.call()</code></a></li>
<li class="chapter" data-level="20.6.3" data-path="evaluation.html"><a href="evaluation.html#exercises-65"><i class="fa fa-check"></i><b>20.6.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="translation.html"><a href="translation.html"><i class="fa fa-check"></i><b>21</b> Translating R code</a>
<ul>
<li class="chapter" data-level="21.1" data-path="translation.html"><a href="translation.html#introduction-20"><i class="fa fa-check"></i><b>21.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="translation.html"><a href="translation.html#outline-19"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="translation.html"><a href="translation.html#prerequisites-14"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="21.2" data-path="translation.html"><a href="translation.html#html"><i class="fa fa-check"></i><b>21.2</b> HTML</a>
<ul>
<li class="chapter" data-level="21.2.1" data-path="translation.html"><a href="translation.html#goal"><i class="fa fa-check"></i><b>21.2.1</b> Goal</a></li>
<li class="chapter" data-level="21.2.2" data-path="translation.html"><a href="translation.html#escaping"><i class="fa fa-check"></i><b>21.2.2</b> Escaping</a></li>
<li class="chapter" data-level="21.2.3" data-path="translation.html"><a href="translation.html#basic-tag-functions"><i class="fa fa-check"></i><b>21.2.3</b> Basic tag functions</a></li>
<li class="chapter" data-level="21.2.4" data-path="translation.html"><a href="translation.html#tag-functions"><i class="fa fa-check"></i><b>21.2.4</b> Tag functions</a></li>
<li class="chapter" data-level="21.2.5" data-path="translation.html"><a href="translation.html#html-env"><i class="fa fa-check"></i><b>21.2.5</b> Processing all tags</a></li>
<li class="chapter" data-level="21.2.6" data-path="translation.html"><a href="translation.html#exercises-66"><i class="fa fa-check"></i><b>21.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="21.3" data-path="translation.html"><a href="translation.html#latex"><i class="fa fa-check"></i><b>21.3</b> LaTeX</a>
<ul>
<li class="chapter" data-level="21.3.1" data-path="translation.html"><a href="translation.html#latex-mathematics"><i class="fa fa-check"></i><b>21.3.1</b> LaTeX mathematics</a></li>
<li class="chapter" data-level="21.3.2" data-path="translation.html"><a href="translation.html#goal-1"><i class="fa fa-check"></i><b>21.3.2</b> Goal</a></li>
<li class="chapter" data-level="21.3.3" data-path="translation.html"><a href="translation.html#to_math"><i class="fa fa-check"></i><b>21.3.3</b> <code>to_math</code>()</a></li>
<li class="chapter" data-level="21.3.4" data-path="translation.html"><a href="translation.html#known-symbols"><i class="fa fa-check"></i><b>21.3.4</b> Known symbols</a></li>
<li class="chapter" data-level="21.3.5" data-path="translation.html"><a href="translation.html#unknown-symbols"><i class="fa fa-check"></i><b>21.3.5</b> Unknown symbols</a></li>
<li class="chapter" data-level="21.3.6" data-path="translation.html"><a href="translation.html#known-functions"><i class="fa fa-check"></i><b>21.3.6</b> Known functions</a></li>
<li class="chapter" data-level="21.3.7" data-path="translation.html"><a href="translation.html#unknown-functions"><i class="fa fa-check"></i><b>21.3.7</b> Unknown functions</a></li>
<li class="chapter" data-level="21.3.8" data-path="translation.html"><a href="translation.html#exercises-67"><i class="fa fa-check"></i><b>21.3.8</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>V Techniques</b></span></li>
<li class="chapter" data-level="" data-path="techniques.html"><a href="techniques.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="22" data-path="debugging.html"><a href="debugging.html"><i class="fa fa-check"></i><b>22</b> Debugging</a>
<ul>
<li class="chapter" data-level="22.1" data-path="debugging.html"><a href="debugging.html#introduction-21"><i class="fa fa-check"></i><b>22.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="debugging.html"><a href="debugging.html#outline-20"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="22.2" data-path="debugging.html"><a href="debugging.html#debugging-strategy"><i class="fa fa-check"></i><b>22.2</b> Overall approach</a></li>
<li class="chapter" data-level="22.3" data-path="debugging.html"><a href="debugging.html#traceback"><i class="fa fa-check"></i><b>22.3</b> Locating errors</a>
<ul>
<li class="chapter" data-level="22.3.1" data-path="debugging.html"><a href="debugging.html#debug-lazy"><i class="fa fa-check"></i><b>22.3.1</b> Lazy evaluation</a></li>
</ul></li>
<li class="chapter" data-level="22.4" data-path="debugging.html"><a href="debugging.html#browser"><i class="fa fa-check"></i><b>22.4</b> Interactive debugger</a>
<ul>
<li class="chapter" data-level="22.4.1" data-path="debugging.html"><a href="debugging.html#browser-commands"><i class="fa fa-check"></i><b>22.4.1</b> <code>browser()</code> commands</a></li>
<li class="chapter" data-level="22.4.2" data-path="debugging.html"><a href="debugging.html#alternatives"><i class="fa fa-check"></i><b>22.4.2</b> Alternatives</a></li>
<li class="chapter" data-level="22.4.3" data-path="debugging.html"><a href="debugging.html#debug-compiled"><i class="fa fa-check"></i><b>22.4.3</b> Compiled code</a></li>
</ul></li>
<li class="chapter" data-level="22.5" data-path="debugging.html"><a href="debugging.html#non-interactive-debugging"><i class="fa fa-check"></i><b>22.5</b> Non-interactive debugging</a>
<ul>
<li class="chapter" data-level="22.5.1" data-path="debugging.html"><a href="debugging.html#dump.frames"><i class="fa fa-check"></i><b>22.5.1</b> <code>dump.frames()</code></a></li>
<li class="chapter" data-level="22.5.2" data-path="debugging.html"><a href="debugging.html#print-debugging"><i class="fa fa-check"></i><b>22.5.2</b> Print debugging</a></li>
<li class="chapter" data-level="22.5.3" data-path="debugging.html"><a href="debugging.html#rmarkdown"><i class="fa fa-check"></i><b>22.5.3</b> RMarkdown</a></li>
</ul></li>
<li class="chapter" data-level="22.6" data-path="debugging.html"><a href="debugging.html#non-error-failures"><i class="fa fa-check"></i><b>22.6</b> Non-error failures</a></li>
</ul></li>
<li class="chapter" data-level="23" data-path="perf-measure.html"><a href="perf-measure.html"><i class="fa fa-check"></i><b>23</b> Measuring performance</a>
<ul>
<li class="chapter" data-level="23.1" data-path="perf-measure.html"><a href="perf-measure.html#introduction-22"><i class="fa fa-check"></i><b>23.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="perf-measure.html"><a href="perf-measure.html#outline-21"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="perf-measure.html"><a href="perf-measure.html#prerequisites-15"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="23.2" data-path="perf-measure.html"><a href="perf-measure.html#profiling"><i class="fa fa-check"></i><b>23.2</b> Profiling</a>
<ul>
<li class="chapter" data-level="23.2.1" data-path="perf-measure.html"><a href="perf-measure.html#visualising-profiles"><i class="fa fa-check"></i><b>23.2.1</b> Visualising profiles</a></li>
<li class="chapter" data-level="23.2.2" data-path="perf-measure.html"><a href="perf-measure.html#memory-profiling"><i class="fa fa-check"></i><b>23.2.2</b> Memory profiling</a></li>
<li class="chapter" data-level="23.2.3" data-path="perf-measure.html"><a href="perf-measure.html#limitations"><i class="fa fa-check"></i><b>23.2.3</b> Limitations</a></li>
<li class="chapter" data-level="23.2.4" data-path="perf-measure.html"><a href="perf-measure.html#exercises-68"><i class="fa fa-check"></i><b>23.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="23.3" data-path="perf-measure.html"><a href="perf-measure.html#microbenchmarking"><i class="fa fa-check"></i><b>23.3</b> Microbenchmarking</a>
<ul>
<li class="chapter" data-level="23.3.1" data-path="perf-measure.html"><a href="perf-measure.html#benchmark-results"><i class="fa fa-check"></i><b>23.3.1</b> <code>bench::mark()</code> results</a></li>
<li class="chapter" data-level="23.3.2" data-path="perf-measure.html"><a href="perf-measure.html#interpreting-results"><i class="fa fa-check"></i><b>23.3.2</b> Interpreting results</a></li>
<li class="chapter" data-level="23.3.3" data-path="perf-measure.html"><a href="perf-measure.html#exercises-69"><i class="fa fa-check"></i><b>23.3.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="24" data-path="perf-improve.html"><a href="perf-improve.html"><i class="fa fa-check"></i><b>24</b> Improving performance</a>
<ul>
<li class="chapter" data-level="24.1" data-path="perf-improve.html"><a href="perf-improve.html#introduction-23"><i class="fa fa-check"></i><b>24.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="perf-improve.html"><a href="perf-improve.html#outline-22"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="perf-improve.html"><a href="perf-improve.html#prerequisites-16"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="24.2" data-path="perf-improve.html"><a href="perf-improve.html#code-organisation"><i class="fa fa-check"></i><b>24.2</b> Code organisation</a></li>
<li class="chapter" data-level="24.3" data-path="perf-improve.html"><a href="perf-improve.html#already-solved"><i class="fa fa-check"></i><b>24.3</b> Checking for existing solutions</a>
<ul>
<li class="chapter" data-level="24.3.1" data-path="perf-improve.html"><a href="perf-improve.html#exercises-70"><i class="fa fa-check"></i><b>24.3.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="24.4" data-path="perf-improve.html"><a href="perf-improve.html#be-lazy"><i class="fa fa-check"></i><b>24.4</b> Doing as little as possible</a>
<ul>
<li class="chapter" data-level="24.4.1" data-path="perf-improve.html"><a href="perf-improve.html#mean"><i class="fa fa-check"></i><b>24.4.1</b> <code>mean()</code></a></li>
<li class="chapter" data-level="24.4.2" data-path="perf-improve.html"><a href="perf-improve.html#as.data.frame"><i class="fa fa-check"></i><b>24.4.2</b> <code>as.data.frame()</code></a></li>
<li class="chapter" data-level="24.4.3" data-path="perf-improve.html"><a href="perf-improve.html#exercises-71"><i class="fa fa-check"></i><b>24.4.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="24.5" data-path="perf-improve.html"><a href="perf-improve.html#vectorise"><i class="fa fa-check"></i><b>24.5</b> Vectorise</a>
<ul>
<li class="chapter" data-level="24.5.1" data-path="perf-improve.html"><a href="perf-improve.html#exercises-72"><i class="fa fa-check"></i><b>24.5.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="24.6" data-path="perf-improve.html"><a href="perf-improve.html#avoid-copies"><i class="fa fa-check"></i><b>24.6</b> Avoiding copies</a></li>
<li class="chapter" data-level="24.7" data-path="perf-improve.html"><a href="perf-improve.html#t-test"><i class="fa fa-check"></i><b>24.7</b> Case study: t-test</a></li>
<li class="chapter" data-level="24.8" data-path="perf-improve.html"><a href="perf-improve.html#more-techniques"><i class="fa fa-check"></i><b>24.8</b> Other techniques</a></li>
</ul></li>
<li class="chapter" data-level="25" data-path="rcpp.html"><a href="rcpp.html"><i class="fa fa-check"></i><b>25</b> Rewriting R code in C++</a>
<ul>
<li class="chapter" data-level="25.1" data-path="rcpp.html"><a href="rcpp.html#introduction-24"><i class="fa fa-check"></i><b>25.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="rcpp.html"><a href="rcpp.html#outline-23"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="rcpp.html"><a href="rcpp.html#prerequisites-17"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="25.2" data-path="rcpp.html"><a href="rcpp.html#rcpp-intro"><i class="fa fa-check"></i><b>25.2</b> Getting started with C++</a>
<ul>
<li class="chapter" data-level="25.2.1" data-path="rcpp.html"><a href="rcpp.html#no-inputs-scalar-output"><i class="fa fa-check"></i><b>25.2.1</b> No inputs, scalar output</a></li>
<li class="chapter" data-level="25.2.2" data-path="rcpp.html"><a href="rcpp.html#scalar-input-scalar-output"><i class="fa fa-check"></i><b>25.2.2</b> Scalar input, scalar output</a></li>
<li class="chapter" data-level="25.2.3" data-path="rcpp.html"><a href="rcpp.html#vector-input-scalar-output"><i class="fa fa-check"></i><b>25.2.3</b> Vector input, scalar output</a></li>
<li class="chapter" data-level="25.2.4" data-path="rcpp.html"><a href="rcpp.html#vector-input-vector-output"><i class="fa fa-check"></i><b>25.2.4</b> Vector input, vector output</a></li>
<li class="chapter" data-level="25.2.5" data-path="rcpp.html"><a href="rcpp.html#sourceCpp"><i class="fa fa-check"></i><b>25.2.5</b> Using sourceCpp</a></li>
<li class="chapter" data-level="25.2.6" data-path="rcpp.html"><a href="rcpp.html#exercise-started"><i class="fa fa-check"></i><b>25.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="25.3" data-path="rcpp.html"><a href="rcpp.html#rcpp-classes"><i class="fa fa-check"></i><b>25.3</b> Other classes</a>
<ul>
<li class="chapter" data-level="25.3.1" data-path="rcpp.html"><a href="rcpp.html#lists-and-data-frames"><i class="fa fa-check"></i><b>25.3.1</b> Lists and data frames</a></li>
<li class="chapter" data-level="25.3.2" data-path="rcpp.html"><a href="rcpp.html#functions-rcpp"><i class="fa fa-check"></i><b>25.3.2</b> Functions</a></li>
<li class="chapter" data-level="25.3.3" data-path="rcpp.html"><a href="rcpp.html#attributes-1"><i class="fa fa-check"></i><b>25.3.3</b> Attributes</a></li>
</ul></li>
<li class="chapter" data-level="25.4" data-path="rcpp.html"><a href="rcpp.html#rcpp-na"><i class="fa fa-check"></i><b>25.4</b> Missing values</a>
<ul>
<li class="chapter" data-level="25.4.1" data-path="rcpp.html"><a href="rcpp.html#scalars-1"><i class="fa fa-check"></i><b>25.4.1</b> Scalars</a></li>
<li class="chapter" data-level="25.4.2" data-path="rcpp.html"><a href="rcpp.html#strings"><i class="fa fa-check"></i><b>25.4.2</b> Strings</a></li>
<li class="chapter" data-level="25.4.3" data-path="rcpp.html"><a href="rcpp.html#boolean"><i class="fa fa-check"></i><b>25.4.3</b> Boolean</a></li>
<li class="chapter" data-level="25.4.4" data-path="rcpp.html"><a href="rcpp.html#vectors-rcpp"><i class="fa fa-check"></i><b>25.4.4</b> Vectors</a></li>
<li class="chapter" data-level="25.4.5" data-path="rcpp.html"><a href="rcpp.html#exercises-73"><i class="fa fa-check"></i><b>25.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="25.5" data-path="rcpp.html"><a href="rcpp.html#stl"><i class="fa fa-check"></i><b>25.5</b> Standard Template Library</a>
<ul>
<li class="chapter" data-level="25.5.1" data-path="rcpp.html"><a href="rcpp.html#using-iterators"><i class="fa fa-check"></i><b>25.5.1</b> Using iterators</a></li>
<li class="chapter" data-level="25.5.2" data-path="rcpp.html"><a href="rcpp.html#algorithms"><i class="fa fa-check"></i><b>25.5.2</b> Algorithms</a></li>
<li class="chapter" data-level="25.5.3" data-path="rcpp.html"><a href="rcpp.html#data-structures-rcpp"><i class="fa fa-check"></i><b>25.5.3</b> Data structures</a></li>
<li class="chapter" data-level="25.5.4" data-path="rcpp.html"><a href="rcpp.html#vectors-stl"><i class="fa fa-check"></i><b>25.5.4</b> Vectors</a></li>
<li class="chapter" data-level="25.5.5" data-path="rcpp.html"><a href="rcpp.html#sets"><i class="fa fa-check"></i><b>25.5.5</b> Sets</a></li>
<li class="chapter" data-level="25.5.6" data-path="rcpp.html"><a href="rcpp.html#map-1"><i class="fa fa-check"></i><b>25.5.6</b> Map</a></li>
<li class="chapter" data-level="25.5.7" data-path="rcpp.html"><a href="rcpp.html#exercises-74"><i class="fa fa-check"></i><b>25.5.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="25.6" data-path="rcpp.html"><a href="rcpp.html#rcpp-case-studies"><i class="fa fa-check"></i><b>25.6</b> Case studies</a>
<ul>
<li class="chapter" data-level="25.6.1" data-path="rcpp.html"><a href="rcpp.html#gibbs-sampler"><i class="fa fa-check"></i><b>25.6.1</b> Gibbs sampler</a></li>
<li class="chapter" data-level="25.6.2" data-path="rcpp.html"><a href="rcpp.html#r-vectorisation-versus-c-vectorisation"><i class="fa fa-check"></i><b>25.6.2</b> R vectorisation versus C++ vectorisation</a></li>
</ul></li>
<li class="chapter" data-level="25.7" data-path="rcpp.html"><a href="rcpp.html#rcpp-package"><i class="fa fa-check"></i><b>25.7</b> Using Rcpp in a package</a></li>
<li class="chapter" data-level="25.8" data-path="rcpp.html"><a href="rcpp.html#rcpp-more"><i class="fa fa-check"></i><b>25.8</b> Learning more</a></li>
<li class="chapter" data-level="25.9" data-path="rcpp.html"><a href="rcpp.html#acknowledgments"><i class="fa fa-check"></i><b>25.9</b> Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="evaluation" class="section level1" number="20">
<h1><span class="header-section-number">20</span> Evaluation</h1>
<div id="introduction-19" class="section level2" number="20.1">
<h2><span class="header-section-number">20.1</span> Introduction</h2>
<p>The user-facing inverse of quotation is unquotation: it gives the <em>user</em> the ability to selectively evaluate parts of an otherwise quoted argument. The developer-facing complement of quotation is evaluation: this gives the <em>developer</em> the ability to evaluate quoted expressions in custom environments to achieve specific goals.</p>
<p>This chapter begins with a discussion of evaluation in its purest form. Youll learn how <code>eval()</code> evaluates an expression in an environment, and then how it can be used to implement a number of important base R functions. Once you have the basics under your belt, youll learn extensions to evaluation that are needed for robustness. There are two big new ideas:</p>
<ul>
<li><p>The quosure: a data structure that captures an expression along with its
associated environment, as found in function arguments.</p></li>
<li><p>The data mask, which makes it easier to evaluate an expression in the
context of a data frame. This introduces potential evaluation ambiguity
which well then resolve with data pronouns.</p></li>
</ul>
<p>Together, quasiquotation, quosures, and data masks form what we call <strong>tidy evaluation</strong>, or tidy eval for short. Tidy eval provides a principled approach to non-standard evaluation that makes it possible to use such functions both interactively and embedded with other functions. Tidy evaluation is the most important practical implication of all this theory so well spend a little time exploring the implications. The chapter finishes off with a discussion of the closest related approaches in base R, and how you can program around their drawbacks.</p>
<div id="outline-18" class="section level3 unnumbered">
<h3>Outline</h3>
<ul>
<li><p>Section <a href="evaluation.html#eval">20.2</a> discusses the basics of evaluation using <code>eval()</code>,
and shows how you can use it to implement key functions like <code>local()</code>
and <code>source()</code>.</p></li>
<li><p>Section <a href="evaluation.html#quosures">20.3</a> introduces a new data structure, the quosure, which
combines an expression with an environment. Youll learn how to capture
quosures from promises, and evaluate them using <code>rlang::eval_tidy()</code>.</p></li>
<li><p>Section <a href="evaluation.html#data-masks">20.4</a> extends evaluation with the data mask, which
makes it trivial to intermingle symbols bound in an environment with
variables found in a data frame.</p></li>
<li><p>Section <a href="evaluation.html#tidy-evaluation">20.5</a> shows how to use tidy evaluation in practice,
focussing on the common pattern of quoting and unquoting, and how to
handle ambiguity with pronouns.</p></li>
<li><p>Section <a href="evaluation.html#base-evaluation">20.6</a> circles back to evaluation in base R,
discusses some of the downsides, and shows how to use quasiquotation and
evaluation to wrap functions that use NSE.</p></li>
</ul>
</div>
<div id="prerequisites-13" class="section level3 unnumbered">
<h3>Prerequisites</h3>
<p>Youll need to be familiar with the content of Chapter <a href="expressions.html#expressions">18</a> and Chapter <a href="quasiquotation.html#quasiquotation">19</a>, as well as the environment data structure (Section <a href="environments.html#env-basics">7.2</a>) and the caller environment (Section <a href="environments.html#call-stack">7.5</a>).</p>
<p>Well continue to use <a href="https://rlang.r-lib.org">rlang</a> and <a href="https://purrr.tidyverse.org">purrr</a>.</p>
<div class="sourceCode" id="cb845"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb845-1"><a href="evaluation.html#cb845-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb845-2"><a href="evaluation.html#cb845-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span></code></pre></div>
</div>
</div>
<div id="eval" class="section level2" number="20.2">
<h2><span class="header-section-number">20.2</span> Evaluation basics</h2>
<p>
</p>
<p>Here well explore the details of <code>eval()</code> which we briefly mentioned in the last chapter. It has two key arguments: <code>expr</code> and <code>envir</code>. The first argument, <code>expr</code>, is the object to evaluate, typically a symbol or expression<a href="#fn104" class="footnote-ref" id="fnref104"><sup>104</sup></a>. None of the evaluation functions quote their inputs, so youll usually use them with <code>expr()</code> or similar:</p>
<div class="sourceCode" id="cb846"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb846-1"><a href="evaluation.html#cb846-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb846-2"><a href="evaluation.html#cb846-2" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">expr</span>(x))</span>
<span id="cb846-3"><a href="evaluation.html#cb846-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 10</span></span>
<span id="cb846-4"><a href="evaluation.html#cb846-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb846-5"><a href="evaluation.html#cb846-5" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb846-6"><a href="evaluation.html#cb846-6" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">expr</span>(x <span class="sc">+</span> y))</span>
<span id="cb846-7"><a href="evaluation.html#cb846-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 12</span></span></code></pre></div>
<p>The second argument, <code>env</code>, gives the environment in which the expression should be evaluated, i.e.where to look for the values of <code>x</code>, <code>y</code>, and <code>+</code>. By default, this is the current environment, i.e.the calling environment of <code>eval()</code>, but you can override it if you want:</p>
<div class="sourceCode" id="cb847"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb847-1"><a href="evaluation.html#cb847-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">expr</span>(x <span class="sc">+</span> y), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">1000</span>))</span>
<span id="cb847-2"><a href="evaluation.html#cb847-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 1002</span></span></code></pre></div>
<p>The first argument is evaluated, not quoted, which can lead to confusing results once if you use a custom environment and forget to manually quote:</p>
<div class="sourceCode" id="cb848"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb848-1"><a href="evaluation.html#cb848-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">print</span>(x <span class="sc">+</span> <span class="dv">1</span>), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">1000</span>))</span>
<span id="cb848-2"><a href="evaluation.html#cb848-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 11</span></span>
<span id="cb848-3"><a href="evaluation.html#cb848-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 11</span></span>
<span id="cb848-4"><a href="evaluation.html#cb848-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb848-5"><a href="evaluation.html#cb848-5" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">expr</span>(<span class="fu">print</span>(x <span class="sc">+</span> <span class="dv">1</span>)), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">1000</span>))</span>
<span id="cb848-6"><a href="evaluation.html#cb848-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 1001</span></span></code></pre></div>
<p>Now that youve seen the basics, lets explore some applications. Well focus primarily on base R functions that you might have used before, reimplementing the underlying principles using rlang.</p>
<div id="application-local" class="section level3" number="20.2.1">
<h3><span class="header-section-number">20.2.1</span> Application: <code>local()</code></h3>
<p>Sometimes you want to perform a chunk of calculation that creates some intermediate variables. The intermediate variables have no long-term use and could be quite large, so youd rather not keep them around. One approach is to clean up after yourself using <code>rm()</code>; another is to wrap the code in a function and just call it once. A more elegant approach is to use <code>local()</code>:</p>
<div class="sourceCode" id="cb849"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb849-1"><a href="evaluation.html#cb849-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up variables created earlier</span></span>
<span id="cb849-2"><a href="evaluation.html#cb849-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x, y)</span>
<span id="cb849-3"><a href="evaluation.html#cb849-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb849-4"><a href="evaluation.html#cb849-4" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> <span class="fu">local</span>({</span>
<span id="cb849-5"><a href="evaluation.html#cb849-5" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb849-6"><a href="evaluation.html#cb849-6" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb849-7"><a href="evaluation.html#cb849-7" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">+</span> y</span>
<span id="cb849-8"><a href="evaluation.html#cb849-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb849-9"><a href="evaluation.html#cb849-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb849-10"><a href="evaluation.html#cb849-10" aria-hidden="true" tabindex="-1"></a>foo</span>
<span id="cb849-11"><a href="evaluation.html#cb849-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 210</span></span>
<span id="cb849-12"><a href="evaluation.html#cb849-12" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb849-13"><a href="evaluation.html#cb849-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error in eval(expr, envir, enclos): object &#39;x&#39; not found</span></span>
<span id="cb849-14"><a href="evaluation.html#cb849-14" aria-hidden="true" tabindex="-1"></a>y</span>
<span id="cb849-15"><a href="evaluation.html#cb849-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error in eval(expr, envir, enclos): object &#39;y&#39; not found</span></span></code></pre></div>
<p>The essence of <code>local()</code> is quite simple and re-implemented below. We capture the input expression, and create a new environment in which to evaluate it. This is a new environment (so assignment doesnt affect the existing environment) with the caller environment as parent (so that <code>expr</code> can still access variables in that environment). This effectively emulates running <code>expr</code> as if it was inside a function (i.e.its lexically scoped, Section <a href="functions.html#lexical-scoping">6.4</a>).</p>
<div class="sourceCode" id="cb850"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb850-1"><a href="evaluation.html#cb850-1" aria-hidden="true" tabindex="-1"></a>local2 <span class="ot">&lt;-</span> <span class="cf">function</span>(expr) {</span>
<span id="cb850-2"><a href="evaluation.html#cb850-2" aria-hidden="true" tabindex="-1"></a>  env <span class="ot">&lt;-</span> <span class="fu">env</span>(<span class="fu">caller_env</span>())</span>
<span id="cb850-3"><a href="evaluation.html#cb850-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(<span class="fu">enexpr</span>(expr), env)</span>
<span id="cb850-4"><a href="evaluation.html#cb850-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb850-5"><a href="evaluation.html#cb850-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb850-6"><a href="evaluation.html#cb850-6" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> <span class="fu">local2</span>({</span>
<span id="cb850-7"><a href="evaluation.html#cb850-7" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb850-8"><a href="evaluation.html#cb850-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb850-9"><a href="evaluation.html#cb850-9" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">+</span> y</span>
<span id="cb850-10"><a href="evaluation.html#cb850-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb850-11"><a href="evaluation.html#cb850-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb850-12"><a href="evaluation.html#cb850-12" aria-hidden="true" tabindex="-1"></a>foo</span>
<span id="cb850-13"><a href="evaluation.html#cb850-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 210</span></span>
<span id="cb850-14"><a href="evaluation.html#cb850-14" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb850-15"><a href="evaluation.html#cb850-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error in eval(expr, envir, enclos): object &#39;x&#39; not found</span></span>
<span id="cb850-16"><a href="evaluation.html#cb850-16" aria-hidden="true" tabindex="-1"></a>y</span>
<span id="cb850-17"><a href="evaluation.html#cb850-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error in eval(expr, envir, enclos): object &#39;y&#39; not found</span></span></code></pre></div>
<p>Understanding how <code>base::local()</code> works is harder, as it uses <code>eval()</code> and <code>substitute()</code> together in rather complicated ways. Figuring out exactly whats going on is good practice if you really want to understand the subtleties of <code>substitute()</code> and the base <code>eval()</code> functions, so they are included in the exercises below.</p>
</div>
<div id="application-source" class="section level3" number="20.2.2">
<h3><span class="header-section-number">20.2.2</span> Application: <code>source()</code></h3>
<p>We can create a simple version of <code>source()</code> by combining <code>eval()</code> with <code>parse_expr()</code> from Section <a href="expressions.html#parsing">18.4.3</a>. We read in the file from disk, use <code>parse_expr()</code> to parse the string into a list of expressions, and then use <code>eval()</code> to evaluate each element in turn. This version evaluates the code in the caller environment, and invisibly returns the result of the last expression in the file just like <code>base::source()</code>.</p>
<div class="sourceCode" id="cb851"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb851-1"><a href="evaluation.html#cb851-1" aria-hidden="true" tabindex="-1"></a>source2 <span class="ot">&lt;-</span> <span class="cf">function</span>(path, <span class="at">env =</span> <span class="fu">caller_env</span>()) {</span>
<span id="cb851-2"><a href="evaluation.html#cb851-2" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">readLines</span>(path, <span class="at">warn =</span> <span class="cn">FALSE</span>), <span class="at">collapse =</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb851-3"><a href="evaluation.html#cb851-3" aria-hidden="true" tabindex="-1"></a>  exprs <span class="ot">&lt;-</span> <span class="fu">parse_exprs</span>(file)</span>
<span id="cb851-4"><a href="evaluation.html#cb851-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb851-5"><a href="evaluation.html#cb851-5" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb851-6"><a href="evaluation.html#cb851-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(exprs)) {</span>
<span id="cb851-7"><a href="evaluation.html#cb851-7" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">eval</span>(exprs[[i]], env)</span>
<span id="cb851-8"><a href="evaluation.html#cb851-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb851-9"><a href="evaluation.html#cb851-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb851-10"><a href="evaluation.html#cb851-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(res)</span>
<span id="cb851-11"><a href="evaluation.html#cb851-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The real <code>source()</code> is considerably more complicated because it can <code>echo</code> input and output, and has many other settings that control its behaviour.</p>
<div class="sidebar">
<p><strong>Expression vectors</strong>
</p>
<p><code>base::eval()</code> has special behaviour for expression <em>vectors</em>, evaluating each component in turn. This makes for a very compact implementation of <code>source2()</code> because <code>base::parse()</code> also returns an expression object:</p>
<div class="sourceCode" id="cb852"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb852-1"><a href="evaluation.html#cb852-1" aria-hidden="true" tabindex="-1"></a>source3 <span class="ot">&lt;-</span> <span class="cf">function</span>(file, <span class="at">env =</span> <span class="fu">parent.frame</span>()) {</span>
<span id="cb852-2"><a href="evaluation.html#cb852-2" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">parse</span>(file)</span>
<span id="cb852-3"><a href="evaluation.html#cb852-3" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">eval</span>(lines, <span class="at">envir =</span> env)</span>
<span id="cb852-4"><a href="evaluation.html#cb852-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(res)</span>
<span id="cb852-5"><a href="evaluation.html#cb852-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>While <code>source3()</code> is considerably more concise than <code>source2()</code>, this is the only advantage to expression vectors. Overall I dont believe this benefit outweighs the cost of introducing a new data structure, and hence this book avoids the use of expression vectors.</p>
</div>
</div>
<div id="gotcha-function" class="section level3" number="20.2.3">
<h3><span class="header-section-number">20.2.3</span> Gotcha: <code>function()</code></h3>
<p>
</p>
<p>Theres one small gotcha that you should be aware of if youre using <code>eval()</code> and <code>expr()</code> to generate functions:</p>
<div class="sourceCode" id="cb853"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb853-1"><a href="evaluation.html#cb853-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb853-2"><a href="evaluation.html#cb853-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb853-3"><a href="evaluation.html#cb853-3" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">expr</span>(<span class="cf">function</span>(x, y) <span class="sc">!!</span>x <span class="sc">+</span> <span class="sc">!!</span>y))</span>
<span id="cb853-4"><a href="evaluation.html#cb853-4" aria-hidden="true" tabindex="-1"></a>f</span>
<span id="cb853-5"><a href="evaluation.html#cb853-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; function(x, y) !!x + !!y</span></span></code></pre></div>
<p>This function doesnt look like it will work, but it does:</p>
<div class="sourceCode" id="cb854"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb854-1"><a href="evaluation.html#cb854-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>()</span>
<span id="cb854-2"><a href="evaluation.html#cb854-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 30</span></span></code></pre></div>
<p>This is because, if available, functions print their <code>srcref</code> attribute (Section <a href="functions.html#fun-components">6.2.1</a>), and because <code>srcref</code> is a base R feature its unaware of quasiquotation.</p>
<p>To work around this problem, either use <code>new_function()</code> (Section <a href="quasiquotation.html#new-function">19.7.4</a>) or remove the <code>srcref</code> attribute:</p>
<div class="sourceCode" id="cb855"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb855-1"><a href="evaluation.html#cb855-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(f, <span class="st">&quot;srcref&quot;</span>) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb855-2"><a href="evaluation.html#cb855-2" aria-hidden="true" tabindex="-1"></a>f</span>
<span id="cb855-3"><a href="evaluation.html#cb855-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; function (x, y) </span></span>
<span id="cb855-4"><a href="evaluation.html#cb855-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 + 20</span></span></code></pre></div>
</div>
<div id="exercises-61" class="section level3" number="20.2.4">
<h3><span class="header-section-number">20.2.4</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>Carefully read the documentation for <code>source()</code>. What environment does it
use by default? What if you supply <code>local = TRUE</code>? How do you provide
a custom environment?</p></li>
<li><p>Predict the results of the following lines of code:</p>
<div class="sourceCode" id="cb856"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb856-1"><a href="evaluation.html#cb856-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">expr</span>(<span class="fu">eval</span>(<span class="fu">expr</span>(<span class="fu">eval</span>(<span class="fu">expr</span>(<span class="dv">2</span> <span class="sc">+</span> <span class="dv">2</span>))))))</span>
<span id="cb856-2"><a href="evaluation.html#cb856-2" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">eval</span>(<span class="fu">expr</span>(<span class="fu">eval</span>(<span class="fu">expr</span>(<span class="fu">eval</span>(<span class="fu">expr</span>(<span class="dv">2</span> <span class="sc">+</span> <span class="dv">2</span>)))))))</span>
<span id="cb856-3"><a href="evaluation.html#cb856-3" aria-hidden="true" tabindex="-1"></a><span class="fu">expr</span>(<span class="fu">eval</span>(<span class="fu">expr</span>(<span class="fu">eval</span>(<span class="fu">expr</span>(<span class="fu">eval</span>(<span class="fu">expr</span>(<span class="dv">2</span> <span class="sc">+</span> <span class="dv">2</span>)))))))</span></code></pre></div></li>
<li><p>Fill in the function bodies below to re-implement <code>get()</code> using <code>sym()</code>
and <code>eval()</code>, and<code>assign()</code> using <code>sym()</code>, <code>expr()</code>, and <code>eval()</code>. Dont
worry about the multiple ways of choosing an environment that <code>get()</code> and
<code>assign()</code> support; assume that the user supplies it explicitly.</p>
<div class="sourceCode" id="cb857"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb857-1"><a href="evaluation.html#cb857-1" aria-hidden="true" tabindex="-1"></a><span class="co"># name is a string</span></span>
<span id="cb857-2"><a href="evaluation.html#cb857-2" aria-hidden="true" tabindex="-1"></a>get2 <span class="ot">&lt;-</span> <span class="cf">function</span>(name, env) {}</span>
<span id="cb857-3"><a href="evaluation.html#cb857-3" aria-hidden="true" tabindex="-1"></a>assign2 <span class="ot">&lt;-</span> <span class="cf">function</span>(name, value, env) {}</span></code></pre></div></li>
<li><p>Modify <code>source2()</code> so it returns the result of <em>every</em> expression,
not just the last one. Can you eliminate the for loop?</p></li>
<li><p>We can make <code>base::local()</code> slightly easier to understand by spreading
out over multiple lines:</p>
<div class="sourceCode" id="cb858"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb858-1"><a href="evaluation.html#cb858-1" aria-hidden="true" tabindex="-1"></a>local3 <span class="ot">&lt;-</span> <span class="cf">function</span>(expr, <span class="at">envir =</span> <span class="fu">new.env</span>()) {</span>
<span id="cb858-2"><a href="evaluation.html#cb858-2" aria-hidden="true" tabindex="-1"></a>  call <span class="ot">&lt;-</span> <span class="fu">substitute</span>(<span class="fu">eval</span>(<span class="fu">quote</span>(expr), envir))</span>
<span id="cb858-3"><a href="evaluation.html#cb858-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(call, <span class="at">envir =</span> <span class="fu">parent.frame</span>())</span>
<span id="cb858-4"><a href="evaluation.html#cb858-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Explain how <code>local()</code> works in words. (Hint: you might want to <code>print(call)</code>
to help understand what <code>substitute()</code> is doing, and read the documentation
to remind yourself what environment <code>new.env()</code> will inherit from.)</p></li>
</ol>
</div>
</div>
<div id="quosures" class="section level2" number="20.3">
<h2><span class="header-section-number">20.3</span> Quosures</h2>
<p></p>
<p>Almost every use of <code>eval()</code> involves both an expression and environment. This coupling is so important that we need a data structure that can hold both pieces. Base R does not have such a structure<a href="#fn105" class="footnote-ref" id="fnref105"><sup>105</sup></a> so rlang fills the gap with the <strong>quosure</strong>, an object that contains an expression and an environment. The name is a portmanteau of quoting and closure, because a quosure both quotes the expression and encloses the environment. Quosures reify the internal promise object (Section <a href="functions.html#promises">6.5.1</a>) into something that you can program with.</p>
<p>In this section, youll learn how to create and manipulate quosures, and a little about how they are implemented.</p>
<div id="creating" class="section level3" number="20.3.1">
<h3><span class="header-section-number">20.3.1</span> Creating</h3>
<p></p>
<p>There are three ways to create quosures:</p>
<ul>
<li><p>Use <code>enquo()</code> and <code>enquos()</code> to capture user-supplied expressions.
The vast majority of quosures should be created this way.</p>
<div class="sourceCode" id="cb859"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb859-1"><a href="evaluation.html#cb859-1" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">enquo</span>(x)</span>
<span id="cb859-2"><a href="evaluation.html#cb859-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foo</span>(a <span class="sc">+</span> b)</span>
<span id="cb859-3"><a href="evaluation.html#cb859-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span id="cb859-4"><a href="evaluation.html#cb859-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; expr: ^a + b</span></span>
<span id="cb859-5"><a href="evaluation.html#cb859-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; env:  global</span></span></code></pre></div></li>
<li><p><code>quo()</code> and <code>quos()</code> exist to match to <code>expr()</code> and <code>exprs()</code>, but
they are included only for the sake of completeness and are needed very
rarely. If you find yourself using them, think carefully if <code>expr()</code> and
careful unquoting can eliminate the need to capture the environment.</p>
<div class="sourceCode" id="cb860"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb860-1"><a href="evaluation.html#cb860-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quo</span>(x <span class="sc">+</span> y <span class="sc">+</span> z)</span>
<span id="cb860-2"><a href="evaluation.html#cb860-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span id="cb860-3"><a href="evaluation.html#cb860-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; expr: ^x + y + z</span></span>
<span id="cb860-4"><a href="evaluation.html#cb860-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; env:  global</span></span></code></pre></div>
<p></p></li>
<li><p><code>new_quosure()</code> create a quosure from its components: an expression and
an environment. This is rarely needed in practice, but is useful for
learning, so is used a lot in this chapter.</p>
<div class="sourceCode" id="cb861"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb861-1"><a href="evaluation.html#cb861-1" aria-hidden="true" tabindex="-1"></a><span class="fu">new_quosure</span>(<span class="fu">expr</span>(x <span class="sc">+</span> y), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="dv">10</span>))</span>
<span id="cb861-2"><a href="evaluation.html#cb861-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span id="cb861-3"><a href="evaluation.html#cb861-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; expr: ^x + y</span></span>
<span id="cb861-4"><a href="evaluation.html#cb861-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; env:  0x55d977b003d8</span></span></code></pre></div></li>
</ul>
</div>
<div id="evaluating" class="section level3" number="20.3.2">
<h3><span class="header-section-number">20.3.2</span> Evaluating</h3>
<p>

</p>
<p>Quosures are paired with a new evaluation function <code>eval_tidy()</code> that takes a single quosure instead of an expression-environment pair. It is straightforward to use:</p>
<div class="sourceCode" id="cb862"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb862-1"><a href="evaluation.html#cb862-1" aria-hidden="true" tabindex="-1"></a>q1 <span class="ot">&lt;-</span> <span class="fu">new_quosure</span>(<span class="fu">expr</span>(x <span class="sc">+</span> y), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="dv">10</span>))</span>
<span id="cb862-2"><a href="evaluation.html#cb862-2" aria-hidden="true" tabindex="-1"></a><span class="fu">eval_tidy</span>(q1)</span>
<span id="cb862-3"><a href="evaluation.html#cb862-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 11</span></span></code></pre></div>
<p>For this simple case, <code>eval_tidy(q1)</code> is basically a shortcut for <code>eval(get_expr(q1), get_env(q1))</code>. However, it has two important features that youll learn about later in the chapter: it supports nested quosures (Section <a href="evaluation.html#nested-quosures">20.3.5</a>) and pronouns (Section <a href="evaluation.html#pronouns">20.4.2</a>).</p>
</div>
<div id="quosure-dots" class="section level3" number="20.3.3">
<h3><span class="header-section-number">20.3.3</span> Dots</h3>
<p>Quosures are typically just a convenience: they make code cleaner because you only have one object to pass around, instead of two. They are, however, essential when it comes to working with <code>...</code> because its possible for each argument passed to <code>...</code> to be associated with a different environment. In the following example note that both quosures have the same expression, <code>x</code>, but a different environment:</p>
<div class="sourceCode" id="cb863"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb863-1"><a href="evaluation.html#cb863-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb863-2"><a href="evaluation.html#cb863-2" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb863-3"><a href="evaluation.html#cb863-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">g</span>(..., <span class="at">f =</span> x)</span>
<span id="cb863-4"><a href="evaluation.html#cb863-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb863-5"><a href="evaluation.html#cb863-5" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb863-6"><a href="evaluation.html#cb863-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enquos</span>(...)</span>
<span id="cb863-7"><a href="evaluation.html#cb863-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb863-8"><a href="evaluation.html#cb863-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb863-9"><a href="evaluation.html#cb863-9" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb863-10"><a href="evaluation.html#cb863-10" aria-hidden="true" tabindex="-1"></a>qs <span class="ot">&lt;-</span> <span class="fu">f</span>(<span class="at">global =</span> x)</span>
<span id="cb863-11"><a href="evaluation.html#cb863-11" aria-hidden="true" tabindex="-1"></a>qs</span>
<span id="cb863-12"><a href="evaluation.html#cb863-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;list_of&lt;quosure&gt;&gt;</span></span>
<span id="cb863-13"><a href="evaluation.html#cb863-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb863-14"><a href="evaluation.html#cb863-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $global</span></span>
<span id="cb863-15"><a href="evaluation.html#cb863-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span id="cb863-16"><a href="evaluation.html#cb863-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; expr: ^x</span></span>
<span id="cb863-17"><a href="evaluation.html#cb863-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; env:  global</span></span>
<span id="cb863-18"><a href="evaluation.html#cb863-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb863-19"><a href="evaluation.html#cb863-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $f</span></span>
<span id="cb863-20"><a href="evaluation.html#cb863-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span id="cb863-21"><a href="evaluation.html#cb863-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; expr: ^x</span></span>
<span id="cb863-22"><a href="evaluation.html#cb863-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; env:  0x55d97845d040</span></span></code></pre></div>
<p>That means that when you evaluate them, you get the correct results:</p>
<div class="sourceCode" id="cb864"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb864-1"><a href="evaluation.html#cb864-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(qs, eval_tidy)</span>
<span id="cb864-2"><a href="evaluation.html#cb864-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; global      f </span></span>
<span id="cb864-3"><a href="evaluation.html#cb864-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      0      1</span></span></code></pre></div>
<p>Correctly evaluating the elements of <code>...</code> was one of the original motivations for the development of quosures.</p>
</div>
<div id="quosure-impl" class="section level3" number="20.3.4">
<h3><span class="header-section-number">20.3.4</span> Under the hood</h3>
<p>
</p>
<p>Quosures were inspired by Rs formulas, because formulas capture an expression and an environment:</p>
<div class="sourceCode" id="cb865"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb865-1"><a href="evaluation.html#cb865-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">runif</span>(<span class="dv">3</span>)</span>
<span id="cb865-2"><a href="evaluation.html#cb865-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(f)</span>
<span id="cb865-3"><a href="evaluation.html#cb865-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Class &#39;formula&#39;  language ~runif(3)</span></span>
<span id="cb865-4"><a href="evaluation.html#cb865-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt;</span></span></code></pre></div>
<p>An early version of tidy evaluation used formulas instead of quosures, as an attractive feature of <code>~</code> is that it provides quoting with a single keystroke. Unfortunately, however, there is no clean way to make <code>~</code> a quasiquoting function.</p>
<p>Quosures are a subclass of formulas:</p>
<div class="sourceCode" id="cb866"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb866-1"><a href="evaluation.html#cb866-1" aria-hidden="true" tabindex="-1"></a>q4 <span class="ot">&lt;-</span> <span class="fu">new_quosure</span>(<span class="fu">expr</span>(x <span class="sc">+</span> y <span class="sc">+</span> z))</span>
<span id="cb866-2"><a href="evaluation.html#cb866-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(q4)</span>
<span id="cb866-3"><a href="evaluation.html#cb866-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;quosure&quot; &quot;formula&quot;</span></span></code></pre></div>
<p>which means that under the hood, quosures, like formulas, are call objects:</p>
<div class="sourceCode" id="cb867"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb867-1"><a href="evaluation.html#cb867-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is_call</span>(q4)</span>
<span id="cb867-2"><a href="evaluation.html#cb867-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span>
<span id="cb867-3"><a href="evaluation.html#cb867-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb867-4"><a href="evaluation.html#cb867-4" aria-hidden="true" tabindex="-1"></a>q4[[<span class="dv">1</span>]]</span>
<span id="cb867-5"><a href="evaluation.html#cb867-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Subsetting quosures with `[[` is deprecated as of rlang 0.4.0</span></span>
<span id="cb867-6"><a href="evaluation.html#cb867-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Please use `quo_get_expr()` instead.</span></span>
<span id="cb867-7"><a href="evaluation.html#cb867-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; This warning is displayed once per session.</span></span>
<span id="cb867-8"><a href="evaluation.html#cb867-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `~`</span></span>
<span id="cb867-9"><a href="evaluation.html#cb867-9" aria-hidden="true" tabindex="-1"></a>q4[[<span class="dv">2</span>]]</span>
<span id="cb867-10"><a href="evaluation.html#cb867-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; x + y + z</span></span></code></pre></div>
<p>with an attribute that stores the environment:</p>
<div class="sourceCode" id="cb868"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb868-1"><a href="evaluation.html#cb868-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(q4, <span class="st">&quot;.Environment&quot;</span>)</span>
<span id="cb868-2"><a href="evaluation.html#cb868-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;environment: R_GlobalEnv&gt;</span></span></code></pre></div>
<p>If you need to extract the expression or environment, dont rely on these implementation details. Instead use <code>get_expr()</code> and <code>get_env()</code>:</p>
<div class="sourceCode" id="cb869"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb869-1"><a href="evaluation.html#cb869-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_expr</span>(q4)</span>
<span id="cb869-2"><a href="evaluation.html#cb869-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; x + y + z</span></span>
<span id="cb869-3"><a href="evaluation.html#cb869-3" aria-hidden="true" tabindex="-1"></a><span class="fu">get_env</span>(q4)</span>
<span id="cb869-4"><a href="evaluation.html#cb869-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;environment: R_GlobalEnv&gt;</span></span></code></pre></div>
</div>
<div id="nested-quosures" class="section level3" number="20.3.5">
<h3><span class="header-section-number">20.3.5</span> Nested quosures</h3>
<p></p>
<p>Its possible to use quasiquotation to embed a quosure in an expression. This is an advanced tool, and most of the time you dont need to think about it because it just works, but I talk about it here so you can spot nested quosures in the wild and not be confused. Take this example, which inlines two quosures into an expression:</p>
<div class="sourceCode" id="cb870"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb870-1"><a href="evaluation.html#cb870-1" aria-hidden="true" tabindex="-1"></a>q2 <span class="ot">&lt;-</span> <span class="fu">new_quosure</span>(<span class="fu">expr</span>(x), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">1</span>))</span>
<span id="cb870-2"><a href="evaluation.html#cb870-2" aria-hidden="true" tabindex="-1"></a>q3 <span class="ot">&lt;-</span> <span class="fu">new_quosure</span>(<span class="fu">expr</span>(x), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">10</span>))</span>
<span id="cb870-3"><a href="evaluation.html#cb870-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb870-4"><a href="evaluation.html#cb870-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="sc">!!</span>q2 <span class="sc">+</span> <span class="sc">!!</span>q3)</span></code></pre></div>
<p>It evaluates correctly with <code>eval_tidy()</code>:</p>
<div class="sourceCode" id="cb871"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb871-1"><a href="evaluation.html#cb871-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval_tidy</span>(x)</span>
<span id="cb871-2"><a href="evaluation.html#cb871-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 11</span></span></code></pre></div>
<p>However, if you print it, you only see the <code>x</code>s, with their formula heritage leaking through:</p>
<div class="sourceCode" id="cb872"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb872-1"><a href="evaluation.html#cb872-1" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb872-2"><a href="evaluation.html#cb872-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (~x) + ~x</span></span></code></pre></div>
<p>You can get a better display with <code>rlang::expr_print()</code> (Section <a href="quasiquotation.html#non-standard-ast">19.4.7</a>):</p>
<div class="sourceCode" id="cb873"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb873-1"><a href="evaluation.html#cb873-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expr_print</span>(x)</span>
<span id="cb873-2"><a href="evaluation.html#cb873-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (^x) + (^x)</span></span></code></pre></div>
<p>When you use <code>expr_print()</code> in the console, quosures are coloured according to their environment, making it easier to spot when symbols are bound to different variables.</p>
</div>
<div id="exercises-62" class="section level3" number="20.3.6">
<h3><span class="header-section-number">20.3.6</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>Predict what each of the following quosures will return if
evaluated.</p>
<div class="sourceCode" id="cb874"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb874-1"><a href="evaluation.html#cb874-1" aria-hidden="true" tabindex="-1"></a>q1 <span class="ot">&lt;-</span> <span class="fu">new_quosure</span>(<span class="fu">expr</span>(x), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">1</span>))</span>
<span id="cb874-2"><a href="evaluation.html#cb874-2" aria-hidden="true" tabindex="-1"></a>q1</span>
<span id="cb874-3"><a href="evaluation.html#cb874-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span id="cb874-4"><a href="evaluation.html#cb874-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; expr: ^x</span></span>
<span id="cb874-5"><a href="evaluation.html#cb874-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; env:  0x55d977855290</span></span>
<span id="cb874-6"><a href="evaluation.html#cb874-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb874-7"><a href="evaluation.html#cb874-7" aria-hidden="true" tabindex="-1"></a>q2 <span class="ot">&lt;-</span> <span class="fu">new_quosure</span>(<span class="fu">expr</span>(x <span class="sc">+</span> <span class="sc">!!</span>q1), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">10</span>))</span>
<span id="cb874-8"><a href="evaluation.html#cb874-8" aria-hidden="true" tabindex="-1"></a>q2</span>
<span id="cb874-9"><a href="evaluation.html#cb874-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span id="cb874-10"><a href="evaluation.html#cb874-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; expr: ^x + (^x)</span></span>
<span id="cb874-11"><a href="evaluation.html#cb874-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; env:  0x55d9770ee940</span></span>
<span id="cb874-12"><a href="evaluation.html#cb874-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb874-13"><a href="evaluation.html#cb874-13" aria-hidden="true" tabindex="-1"></a>q3 <span class="ot">&lt;-</span> <span class="fu">new_quosure</span>(<span class="fu">expr</span>(x <span class="sc">+</span> <span class="sc">!!</span>q2), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">100</span>))</span>
<span id="cb874-14"><a href="evaluation.html#cb874-14" aria-hidden="true" tabindex="-1"></a>q3</span>
<span id="cb874-15"><a href="evaluation.html#cb874-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span id="cb874-16"><a href="evaluation.html#cb874-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; expr: ^x + (^x + (^x))</span></span>
<span id="cb874-17"><a href="evaluation.html#cb874-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; env:  0x55d975673f08</span></span></code></pre></div></li>
<li><p>Write an <code>enenv()</code> function that captures the environment associated
with an argument. (Hint: this should only require two function calls.)</p></li>
</ol>
</div>
</div>
<div id="data-masks" class="section level2" number="20.4">
<h2><span class="header-section-number">20.4</span> Data masks</h2>
<p></p>
<p>In this section, youll learn about the <strong>data mask</strong>, a data frame where the evaluated code will look first for variable definitions. The data mask is the key idea that powers base functions like <code>with()</code>, <code>subset()</code> and <code>transform()</code>, and is used throughout the tidyverse in packages like dplyr and ggplot2.</p>
<div id="basics-3" class="section level3" number="20.4.1">
<h3><span class="header-section-number">20.4.1</span> Basics</h3>
<p>The data mask allows you to mingle variables from an environment and a data frame in a single expression. You supply the data mask as the second argument to <code>eval_tidy()</code>:</p>
<div class="sourceCode" id="cb875"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb875-1"><a href="evaluation.html#cb875-1" aria-hidden="true" tabindex="-1"></a>q1 <span class="ot">&lt;-</span> <span class="fu">new_quosure</span>(<span class="fu">expr</span>(x <span class="sc">*</span> y), <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">100</span>))</span>
<span id="cb875-2"><a href="evaluation.html#cb875-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb875-3"><a href="evaluation.html#cb875-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb875-4"><a href="evaluation.html#cb875-4" aria-hidden="true" tabindex="-1"></a><span class="fu">eval_tidy</span>(q1, df)</span>
<span id="cb875-5"><a href="evaluation.html#cb875-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1]  100  200  300  400  500  600  700  800  900 1000</span></span></code></pre></div>
<p>This code is a little hard to follow because theres so much syntax as were creating every object from scratch. Its easier to see whats going on if we make a little wrapper. I call this <code>with2()</code> because its equivalent to <code>base::with()</code>.
</p>
<div class="sourceCode" id="cb876"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb876-1"><a href="evaluation.html#cb876-1" aria-hidden="true" tabindex="-1"></a>with2 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, expr) {</span>
<span id="cb876-2"><a href="evaluation.html#cb876-2" aria-hidden="true" tabindex="-1"></a>  expr <span class="ot">&lt;-</span> <span class="fu">enquo</span>(expr)</span>
<span id="cb876-3"><a href="evaluation.html#cb876-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval_tidy</span>(expr, data)</span>
<span id="cb876-4"><a href="evaluation.html#cb876-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We can now rewrite the code above as below:</p>
<div class="sourceCode" id="cb877"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb877-1"><a href="evaluation.html#cb877-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb877-2"><a href="evaluation.html#cb877-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with2</span>(df, x <span class="sc">*</span> y)</span>
<span id="cb877-3"><a href="evaluation.html#cb877-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1]  100  200  300  400  500  600  700  800  900 1000</span></span></code></pre></div>
<p><code>base::eval()</code> has similar functionality, although it doesnt call it a data mask. Instead you can supply a data frame to the second argument and an environment to the third. That gives the following implementation of <code>with()</code>:</p>
<div class="sourceCode" id="cb878"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb878-1"><a href="evaluation.html#cb878-1" aria-hidden="true" tabindex="-1"></a>with3 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, expr) {</span>
<span id="cb878-2"><a href="evaluation.html#cb878-2" aria-hidden="true" tabindex="-1"></a>  expr <span class="ot">&lt;-</span> <span class="fu">substitute</span>(expr)</span>
<span id="cb878-3"><a href="evaluation.html#cb878-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(expr, data, <span class="fu">caller_env</span>())</span>
<span id="cb878-4"><a href="evaluation.html#cb878-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="pronouns" class="section level3" number="20.4.2">
<h3><span class="header-section-number">20.4.2</span> Pronouns</h3>
<p>

</p>
<p>Using a data mask introduces ambiguity. For example, in the following code you cant know whether <code>x</code> will come from the data mask or the environment, unless you know what variables are found in <code>df</code>.</p>
<div class="sourceCode" id="cb879"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb879-1"><a href="evaluation.html#cb879-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with2</span>(df, x)</span></code></pre></div>
<p>That makes code harder to reason about (because you need to know more context), which can introduce bugs. To resolve that issue, the data mask provides two pronouns: <code>.data</code> and <code>.env</code>.</p>
<ul>
<li><code>.data$x</code> always refers to <code>x</code> in the data mask.</li>
<li><code>.env$x</code> always refers to <code>x</code> in the environment.</li>
</ul>
<div class="sourceCode" id="cb880"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb880-1"><a href="evaluation.html#cb880-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb880-2"><a href="evaluation.html#cb880-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">2</span>)</span>
<span id="cb880-3"><a href="evaluation.html#cb880-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb880-4"><a href="evaluation.html#cb880-4" aria-hidden="true" tabindex="-1"></a><span class="fu">with2</span>(df, .data<span class="sc">$</span>x)</span>
<span id="cb880-5"><a href="evaluation.html#cb880-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 2</span></span>
<span id="cb880-6"><a href="evaluation.html#cb880-6" aria-hidden="true" tabindex="-1"></a><span class="fu">with2</span>(df, .env<span class="sc">$</span>x)</span>
<span id="cb880-7"><a href="evaluation.html#cb880-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>You can also subset <code>.data</code> and <code>.env</code> using <code>[[</code>, e.g.<code>.data[["x"]]</code>. Otherwise the pronouns are special objects and you shouldnt expect them to behave like data frames or environments. In particular, they throw an error if the object isnt found:</p>
<div class="sourceCode" id="cb881"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb881-1"><a href="evaluation.html#cb881-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with2</span>(df, .data<span class="sc">$</span>y)</span>
<span id="cb881-2"><a href="evaluation.html#cb881-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error: Column `y` not found in `.data`</span></span></code></pre></div>
</div>
<div id="subset" class="section level3" number="20.4.3">
<h3><span class="header-section-number">20.4.3</span> Application: <code>subset()</code></h3>
<p>Well explore tidy evaluation in the context of <code>base::subset()</code>, because its a simple yet powerful function that makes a common data manipulation challenge easier. If you havent used it before, <code>subset()</code>, like <code>dplyr::filter()</code>, provides a convenient way of selecting rows of a data frame. You give it some data, along with an expression that is evaluated in the context of that data. This considerably reduces the number of times you need to type the name of the data frame:</p>
<div class="sourceCode" id="cb882"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb882-1"><a href="evaluation.html#cb882-1" aria-hidden="true" tabindex="-1"></a>sample_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">b =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">c =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>))</span>
<span id="cb882-2"><a href="evaluation.html#cb882-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb882-3"><a href="evaluation.html#cb882-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Shorthand for sample_df[sample_df$a &gt;= 4, ]</span></span>
<span id="cb882-4"><a href="evaluation.html#cb882-4" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(sample_df, a <span class="sc">&gt;=</span> <span class="dv">4</span>)</span>
<span id="cb882-5"><a href="evaluation.html#cb882-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   a b c</span></span>
<span id="cb882-6"><a href="evaluation.html#cb882-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 4 2 4</span></span>
<span id="cb882-7"><a href="evaluation.html#cb882-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5 5 1 1</span></span>
<span id="cb882-8"><a href="evaluation.html#cb882-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb882-9"><a href="evaluation.html#cb882-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Shorthand for sample_df[sample_df$b == sample_df$c, ]</span></span>
<span id="cb882-10"><a href="evaluation.html#cb882-10" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(sample_df, b <span class="sc">==</span> c)</span>
<span id="cb882-11"><a href="evaluation.html#cb882-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   a b c</span></span>
<span id="cb882-12"><a href="evaluation.html#cb882-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1 5 5</span></span>
<span id="cb882-13"><a href="evaluation.html#cb882-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5 5 1 1</span></span></code></pre></div>
<p>The core of our version of <code>subset()</code>, <code>subset2()</code>, is quite simple. It takes two arguments: a data frame, <code>data</code>, and an expression, <code>rows</code>. We evaluate <code>rows</code> using <code>df</code> as a data mask, then use the results to subset the data frame with <code>[</code>. Ive included a very simple check to ensure the result is a logical vector; real code would do more to create an informative error.</p>
<div class="sourceCode" id="cb883"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb883-1"><a href="evaluation.html#cb883-1" aria-hidden="true" tabindex="-1"></a>subset2 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, rows) {</span>
<span id="cb883-2"><a href="evaluation.html#cb883-2" aria-hidden="true" tabindex="-1"></a>  rows <span class="ot">&lt;-</span> <span class="fu">enquo</span>(rows)</span>
<span id="cb883-3"><a href="evaluation.html#cb883-3" aria-hidden="true" tabindex="-1"></a>  rows_val <span class="ot">&lt;-</span> <span class="fu">eval_tidy</span>(rows, data)</span>
<span id="cb883-4"><a href="evaluation.html#cb883-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(rows_val))</span>
<span id="cb883-5"><a href="evaluation.html#cb883-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb883-6"><a href="evaluation.html#cb883-6" aria-hidden="true" tabindex="-1"></a>  data[rows_val, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb883-7"><a href="evaluation.html#cb883-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb883-8"><a href="evaluation.html#cb883-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb883-9"><a href="evaluation.html#cb883-9" aria-hidden="true" tabindex="-1"></a><span class="fu">subset2</span>(sample_df, b <span class="sc">==</span> c)</span>
<span id="cb883-10"><a href="evaluation.html#cb883-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   a b c</span></span>
<span id="cb883-11"><a href="evaluation.html#cb883-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1 5 5</span></span>
<span id="cb883-12"><a href="evaluation.html#cb883-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5 5 1 1</span></span></code></pre></div>
</div>
<div id="application-transform" class="section level3" number="20.4.4">
<h3><span class="header-section-number">20.4.4</span> Application: transform</h3>
<p>A more complicated situation is <code>base::transform()</code> which allows you to add new variables to a data frame, evaluating their expressions in the context of the existing variables:</p>
<div class="sourceCode" id="cb884"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb884-1"><a href="evaluation.html#cb884-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>), <span class="at">y =</span> <span class="fu">runif</span>(<span class="dv">3</span>))</span>
<span id="cb884-2"><a href="evaluation.html#cb884-2" aria-hidden="true" tabindex="-1"></a><span class="fu">transform</span>(df, <span class="at">x =</span> <span class="sc">-</span>x, <span class="at">y2 =</span> <span class="dv">2</span> <span class="sc">*</span> y)</span>
<span id="cb884-3"><a href="evaluation.html#cb884-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    x      y    y2</span></span>
<span id="cb884-4"><a href="evaluation.html#cb884-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 -2 0.0808 0.162</span></span>
<span id="cb884-5"><a href="evaluation.html#cb884-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 -3 0.8343 1.669</span></span>
<span id="cb884-6"><a href="evaluation.html#cb884-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 -1 0.6008 1.202</span></span></code></pre></div>
<p>Again, our own <code>transform2()</code> requires little code. We capture the unevaluated <code>...</code> with <code>enquos(...)</code>, and then evaluate each expression using a for loop. Real code would do more error checking to ensure that each input is named and evaluates to a vector the same length as <code>data</code>.</p>
<div class="sourceCode" id="cb885"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb885-1"><a href="evaluation.html#cb885-1" aria-hidden="true" tabindex="-1"></a>transform2 <span class="ot">&lt;-</span> <span class="cf">function</span>(.data, ...) {</span>
<span id="cb885-2"><a href="evaluation.html#cb885-2" aria-hidden="true" tabindex="-1"></a>  dots <span class="ot">&lt;-</span> <span class="fu">enquos</span>(...)</span>
<span id="cb885-3"><a href="evaluation.html#cb885-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb885-4"><a href="evaluation.html#cb885-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(dots)) {</span>
<span id="cb885-5"><a href="evaluation.html#cb885-5" aria-hidden="true" tabindex="-1"></a>    name <span class="ot">&lt;-</span> <span class="fu">names</span>(dots)[[i]]</span>
<span id="cb885-6"><a href="evaluation.html#cb885-6" aria-hidden="true" tabindex="-1"></a>    dot <span class="ot">&lt;-</span> dots[[i]]</span>
<span id="cb885-7"><a href="evaluation.html#cb885-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb885-8"><a href="evaluation.html#cb885-8" aria-hidden="true" tabindex="-1"></a>    .data[[name]] <span class="ot">&lt;-</span> <span class="fu">eval_tidy</span>(dot, .data)</span>
<span id="cb885-9"><a href="evaluation.html#cb885-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb885-10"><a href="evaluation.html#cb885-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb885-11"><a href="evaluation.html#cb885-11" aria-hidden="true" tabindex="-1"></a>  .data</span>
<span id="cb885-12"><a href="evaluation.html#cb885-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb885-13"><a href="evaluation.html#cb885-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb885-14"><a href="evaluation.html#cb885-14" aria-hidden="true" tabindex="-1"></a><span class="fu">transform2</span>(df, <span class="at">x2 =</span> x <span class="sc">*</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="sc">-</span>y)</span>
<span id="cb885-15"><a href="evaluation.html#cb885-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   x       y x2</span></span>
<span id="cb885-16"><a href="evaluation.html#cb885-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 2 -0.0808  4</span></span>
<span id="cb885-17"><a href="evaluation.html#cb885-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 3 -0.8343  6</span></span>
<span id="cb885-18"><a href="evaluation.html#cb885-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 1 -0.6008  2</span></span></code></pre></div>
<p>NB: I named the first argument <code>.data</code> to avoid problems if users tried to create a variable called <code>data</code>. They will still have problems if they attempt to create a variable called <code>.data</code>, but this is much less likely. This is the same reasoning that leads to the <code>.x</code> and <code>.f</code> arguments to <code>map()</code> (Section <a href="functionals.html#argument-names">9.2.4</a>).</p>
</div>
<div id="select" class="section level3" number="20.4.5">
<h3><span class="header-section-number">20.4.5</span> Application: <code>select()</code></h3>
<p>A data mask will typically be a data frame, but its sometimes useful to provide a list filled with more exotic contents. This is basically how the <code>select</code> argument in <code>base::subset()</code> works. It allows you to refer to variables as if they were numbers:</p>
<div class="sourceCode" id="cb886"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb886-1"><a href="evaluation.html#cb886-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">a =</span> <span class="dv">1</span>, <span class="at">b =</span> <span class="dv">2</span>, <span class="at">c =</span> <span class="dv">3</span>, <span class="at">d =</span> <span class="dv">4</span>, <span class="at">e =</span> <span class="dv">5</span>)</span>
<span id="cb886-2"><a href="evaluation.html#cb886-2" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(df, <span class="at">select =</span> b<span class="sc">:</span>d)</span>
<span id="cb886-3"><a href="evaluation.html#cb886-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   b c d</span></span>
<span id="cb886-4"><a href="evaluation.html#cb886-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 2 3 4</span></span></code></pre></div>
<p>The key idea is to create a named list where each component gives the position of the corresponding variable:</p>
<div class="sourceCode" id="cb887"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb887-1"><a href="evaluation.html#cb887-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">set_names</span>(<span class="fu">seq_along</span>(df), <span class="fu">names</span>(df)))</span>
<span id="cb887-2"><a href="evaluation.html#cb887-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(vars)</span>
<span id="cb887-3"><a href="evaluation.html#cb887-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; List of 5</span></span>
<span id="cb887-4"><a href="evaluation.html#cb887-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  $ a: int 1</span></span>
<span id="cb887-5"><a href="evaluation.html#cb887-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  $ b: int 2</span></span>
<span id="cb887-6"><a href="evaluation.html#cb887-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  $ c: int 3</span></span>
<span id="cb887-7"><a href="evaluation.html#cb887-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  $ d: int 4</span></span>
<span id="cb887-8"><a href="evaluation.html#cb887-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  $ e: int 5</span></span></code></pre></div>
<p>Then implementation is again only a few lines of code:</p>
<div class="sourceCode" id="cb888"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb888-1"><a href="evaluation.html#cb888-1" aria-hidden="true" tabindex="-1"></a>select2 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb888-2"><a href="evaluation.html#cb888-2" aria-hidden="true" tabindex="-1"></a>  dots <span class="ot">&lt;-</span> <span class="fu">enquos</span>(...)</span>
<span id="cb888-3"><a href="evaluation.html#cb888-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb888-4"><a href="evaluation.html#cb888-4" aria-hidden="true" tabindex="-1"></a>  vars <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">set_names</span>(<span class="fu">seq_along</span>(data), <span class="fu">names</span>(data)))</span>
<span id="cb888-5"><a href="evaluation.html#cb888-5" aria-hidden="true" tabindex="-1"></a>  cols <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">map</span>(dots, eval_tidy, vars))</span>
<span id="cb888-6"><a href="evaluation.html#cb888-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb888-7"><a href="evaluation.html#cb888-7" aria-hidden="true" tabindex="-1"></a>  data[, cols, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb888-8"><a href="evaluation.html#cb888-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb888-9"><a href="evaluation.html#cb888-9" aria-hidden="true" tabindex="-1"></a><span class="fu">select2</span>(df, b<span class="sc">:</span>d)</span>
<span id="cb888-10"><a href="evaluation.html#cb888-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   b c d</span></span>
<span id="cb888-11"><a href="evaluation.html#cb888-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 2 3 4</span></span></code></pre></div>
<p><code>dplyr::select()</code> takes this idea and runs with it, providing a number of helpers that allow you to select variables based on their names (e.g.<code>starts_with("x")</code> or <code>ends_with("_a"</code>)).</p>
</div>
<div id="exercises-63" class="section level3" number="20.4.6">
<h3><span class="header-section-number">20.4.6</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>Why did I use a for loop in <code>transform2()</code> instead of <code>map()</code>?
Consider <code>transform2(df, x = x * 2, x = x * 2)</code>.</p></li>
<li><p>Heres an alternative implementation of <code>subset2()</code>:</p>
<div class="sourceCode" id="cb889"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb889-1"><a href="evaluation.html#cb889-1" aria-hidden="true" tabindex="-1"></a>subset3 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, rows) {</span>
<span id="cb889-2"><a href="evaluation.html#cb889-2" aria-hidden="true" tabindex="-1"></a>  rows <span class="ot">&lt;-</span> <span class="fu">enquo</span>(rows)</span>
<span id="cb889-3"><a href="evaluation.html#cb889-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval_tidy</span>(<span class="fu">expr</span>(data[<span class="sc">!!</span>rows, , <span class="at">drop =</span> <span class="cn">FALSE</span>]), <span class="at">data =</span> data)</span>
<span id="cb889-4"><a href="evaluation.html#cb889-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb889-5"><a href="evaluation.html#cb889-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-6"><a href="evaluation.html#cb889-6" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb889-7"><a href="evaluation.html#cb889-7" aria-hidden="true" tabindex="-1"></a><span class="fu">subset3</span>(df, x <span class="sc">==</span> <span class="dv">1</span>)</span></code></pre></div>
<p>Compare and contrast <code>subset3()</code> to <code>subset2()</code>. What are its advantages
and disadvantages?</p></li>
<li><p>The following function implements the basics of <code>dplyr::arrange()</code>.
Annotate each line with a comment explaining what it does. Can you
explain why <code>!!.na.last</code> is strictly correct, but omitting the <code>!!</code>
is unlikely to cause problems?</p>
<div class="sourceCode" id="cb890"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb890-1"><a href="evaluation.html#cb890-1" aria-hidden="true" tabindex="-1"></a>arrange2 <span class="ot">&lt;-</span> <span class="cf">function</span>(.df, ..., <span class="at">.na.last =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb890-2"><a href="evaluation.html#cb890-2" aria-hidden="true" tabindex="-1"></a>  args <span class="ot">&lt;-</span> <span class="fu">enquos</span>(...)</span>
<span id="cb890-3"><a href="evaluation.html#cb890-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb890-4"><a href="evaluation.html#cb890-4" aria-hidden="true" tabindex="-1"></a>  order_call <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="fu">order</span>(<span class="sc">!!!</span>args, <span class="at">na.last =</span> <span class="sc">!!</span>.na.last))</span>
<span id="cb890-5"><a href="evaluation.html#cb890-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb890-6"><a href="evaluation.html#cb890-6" aria-hidden="true" tabindex="-1"></a>  ord <span class="ot">&lt;-</span> <span class="fu">eval_tidy</span>(order_call, .df)</span>
<span id="cb890-7"><a href="evaluation.html#cb890-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(ord) <span class="sc">==</span> <span class="fu">nrow</span>(.df))</span>
<span id="cb890-8"><a href="evaluation.html#cb890-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb890-9"><a href="evaluation.html#cb890-9" aria-hidden="true" tabindex="-1"></a>  .df[ord, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb890-10"><a href="evaluation.html#cb890-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
</ol>
</div>
</div>
<div id="tidy-evaluation" class="section level2" number="20.5">
<h2><span class="header-section-number">20.5</span> Using tidy evaluation</h2>
<p>While its important to understand how <code>eval_tidy()</code> works, most of the time you wont call it directly. Instead, youll usually use it indirectly by calling a function that uses <code>eval_tidy()</code>. This section will give a few practical examples of wrapping functions that use tidy evaluation.</p>
<div id="quoting-and-unquoting" class="section level3" number="20.5.1">
<h3><span class="header-section-number">20.5.1</span> Quoting and unquoting</h3>
<p>

</p>
<p>Imagine we have written a function that resamples a dataset:</p>
<div class="sourceCode" id="cb891"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb891-1"><a href="evaluation.html#cb891-1" aria-hidden="true" tabindex="-1"></a>resample <span class="ot">&lt;-</span> <span class="cf">function</span>(df, n) {</span>
<span id="cb891-2"><a href="evaluation.html#cb891-2" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(df), n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb891-3"><a href="evaluation.html#cb891-3" aria-hidden="true" tabindex="-1"></a>  df[idx, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb891-4"><a href="evaluation.html#cb891-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We want to create a new function that allows us to resample and subset in a single step. Our naive approach doesnt work:</p>
<div class="sourceCode" id="cb892"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb892-1"><a href="evaluation.html#cb892-1" aria-hidden="true" tabindex="-1"></a>subsample <span class="ot">&lt;-</span> <span class="cf">function</span>(df, cond, <span class="at">n =</span> <span class="fu">nrow</span>(df)) {</span>
<span id="cb892-2"><a href="evaluation.html#cb892-2" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">subset2</span>(df, cond)</span>
<span id="cb892-3"><a href="evaluation.html#cb892-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resample</span>(df, n)</span>
<span id="cb892-4"><a href="evaluation.html#cb892-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb892-5"><a href="evaluation.html#cb892-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb892-6"><a href="evaluation.html#cb892-6" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>), <span class="at">y =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb892-7"><a href="evaluation.html#cb892-7" aria-hidden="true" tabindex="-1"></a><span class="fu">subsample</span>(df, x <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb892-8"><a href="evaluation.html#cb892-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error in eval_tidy(rows, data): object &#39;x&#39; not found</span></span></code></pre></div>
<p><code>subsample()</code> doesnt quote any arguments so <code>cond</code> is evaluated normally (not in a data mask), and we get an error when it tries to find a binding for <code>x</code>. To fix this problem we need to quote <code>cond</code>, and then unquote it when we pass it on ot <code>subset2()</code>:</p>
<div class="sourceCode" id="cb893"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb893-1"><a href="evaluation.html#cb893-1" aria-hidden="true" tabindex="-1"></a>subsample <span class="ot">&lt;-</span> <span class="cf">function</span>(df, cond, <span class="at">n =</span> <span class="fu">nrow</span>(df)) {</span>
<span id="cb893-2"><a href="evaluation.html#cb893-2" aria-hidden="true" tabindex="-1"></a>  cond <span class="ot">&lt;-</span> <span class="fu">enquo</span>(cond)</span>
<span id="cb893-3"><a href="evaluation.html#cb893-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb893-4"><a href="evaluation.html#cb893-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">subset2</span>(df, <span class="sc">!!</span>cond)</span>
<span id="cb893-5"><a href="evaluation.html#cb893-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resample</span>(df, n)</span>
<span id="cb893-6"><a href="evaluation.html#cb893-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb893-7"><a href="evaluation.html#cb893-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb893-8"><a href="evaluation.html#cb893-8" aria-hidden="true" tabindex="-1"></a><span class="fu">subsample</span>(df, x <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb893-9"><a href="evaluation.html#cb893-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   x y</span></span>
<span id="cb893-10"><a href="evaluation.html#cb893-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 1 3</span></span>
<span id="cb893-11"><a href="evaluation.html#cb893-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1 1</span></span>
<span id="cb893-12"><a href="evaluation.html#cb893-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 1 2</span></span></code></pre></div>
<p>This is a very common pattern; whenever you call a quoting function with arguments from the user, you need to quote them and then unquote.</p>
<!-- GVW: I really, really want a diagram here to show the various objects in play at each step - it took me a long time to figure out why quote/unquote was needed, and I still have to go back and review it each time I run into it. -->
</div>
<div id="handling-ambiguity" class="section level3" number="20.5.2">
<h3><span class="header-section-number">20.5.2</span> Handling ambiguity</h3>
<p></p>
<p>In the case above, we needed to think about tidy evaluation because of quasiquotation. We also need to think about tidy evaluation even when the wrapper doesnt need to quote any arguments. Take this wrapper around <code>subset2()</code>:</p>
<div class="sourceCode" id="cb894"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb894-1"><a href="evaluation.html#cb894-1" aria-hidden="true" tabindex="-1"></a>threshold_x <span class="ot">&lt;-</span> <span class="cf">function</span>(df, val) {</span>
<span id="cb894-2"><a href="evaluation.html#cb894-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset2</span>(df, x <span class="sc">&gt;=</span> val)</span>
<span id="cb894-3"><a href="evaluation.html#cb894-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This function can silently return an incorrect result in two situations:</p>
<ul>
<li><p>When <code>x</code> exists in the calling environment, but not in <code>df</code>:</p>
<div class="sourceCode" id="cb895"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb895-1"><a href="evaluation.html#cb895-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb895-2"><a href="evaluation.html#cb895-2" aria-hidden="true" tabindex="-1"></a>no_x <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb895-3"><a href="evaluation.html#cb895-3" aria-hidden="true" tabindex="-1"></a><span class="fu">threshold_x</span>(no_x, <span class="dv">2</span>)</span>
<span id="cb895-4"><a href="evaluation.html#cb895-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   y</span></span>
<span id="cb895-5"><a href="evaluation.html#cb895-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1</span></span>
<span id="cb895-6"><a href="evaluation.html#cb895-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 2</span></span>
<span id="cb895-7"><a href="evaluation.html#cb895-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 3</span></span></code></pre></div></li>
<li><p>When <code>val</code> exists in <code>df</code>:</p>
<div class="sourceCode" id="cb896"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb896-1"><a href="evaluation.html#cb896-1" aria-hidden="true" tabindex="-1"></a>has_val <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">val =</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">11</span>)</span>
<span id="cb896-2"><a href="evaluation.html#cb896-2" aria-hidden="true" tabindex="-1"></a><span class="fu">threshold_x</span>(has_val, <span class="dv">2</span>)</span>
<span id="cb896-3"><a href="evaluation.html#cb896-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] x   val</span></span>
<span id="cb896-4"><a href="evaluation.html#cb896-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;0 rows&gt; (or 0-length row.names)</span></span></code></pre></div></li>
</ul>
<p>These failure modes arise because tidy evaluation is ambiguous: each variable can be found in <strong>either</strong> the data mask <strong>or</strong> the environment. To make this function safe we need to remove the ambiguity using the <code>.data</code> and <code>.env</code> pronouns:</p>
<div class="sourceCode" id="cb897"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb897-1"><a href="evaluation.html#cb897-1" aria-hidden="true" tabindex="-1"></a>threshold_x <span class="ot">&lt;-</span> <span class="cf">function</span>(df, val) {</span>
<span id="cb897-2"><a href="evaluation.html#cb897-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset2</span>(df, .data<span class="sc">$</span>x <span class="sc">&gt;=</span> .env<span class="sc">$</span>val)</span>
<span id="cb897-3"><a href="evaluation.html#cb897-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb897-4"><a href="evaluation.html#cb897-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb897-5"><a href="evaluation.html#cb897-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb897-6"><a href="evaluation.html#cb897-6" aria-hidden="true" tabindex="-1"></a><span class="fu">threshold_x</span>(no_x, <span class="dv">2</span>)</span>
<span id="cb897-7"><a href="evaluation.html#cb897-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error: Column `x` not found in `.data`</span></span>
<span id="cb897-8"><a href="evaluation.html#cb897-8" aria-hidden="true" tabindex="-1"></a><span class="fu">threshold_x</span>(has_val, <span class="dv">2</span>)</span>
<span id="cb897-9"><a href="evaluation.html#cb897-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   x val</span></span>
<span id="cb897-10"><a href="evaluation.html#cb897-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 2  10</span></span>
<span id="cb897-11"><a href="evaluation.html#cb897-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 3  11</span></span></code></pre></div>
<p>Generally, whenever you use the <code>.env</code> pronoun, you can use unquoting instead:</p>
<div class="sourceCode" id="cb898"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb898-1"><a href="evaluation.html#cb898-1" aria-hidden="true" tabindex="-1"></a>threshold_x <span class="ot">&lt;-</span> <span class="cf">function</span>(df, val) {</span>
<span id="cb898-2"><a href="evaluation.html#cb898-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset2</span>(df, .data<span class="sc">$</span>x <span class="sc">&gt;=</span> <span class="sc">!!</span>val)</span>
<span id="cb898-3"><a href="evaluation.html#cb898-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>There are subtle differences in when <code>val</code> is evaluated. If you unquote, <code>val</code> will be early evaluated by <code>enquo()</code>; if you use a pronoun, <code>val</code> will be lazily evaluated by <code>eval_tidy()</code>. These differences are usually unimportant, so pick the form that looks most natural.</p>
</div>
<div id="quoting-and-ambiguity" class="section level3" number="20.5.3">
<h3><span class="header-section-number">20.5.3</span> Quoting and ambiguity</h3>
<p>To finish our discussion lets consider the case where we have both quoting and potential ambiguity. Ill generalise <code>threshold_x()</code> slightly so that the user can pick the variable used for thresholding. Here I used <code>.data[[var]]</code> because it makes the code a little simpler; in the exercises youll have a chance to explore how you might use <code>$</code> instead.</p>
<div class="sourceCode" id="cb899"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb899-1"><a href="evaluation.html#cb899-1" aria-hidden="true" tabindex="-1"></a>threshold_var <span class="ot">&lt;-</span> <span class="cf">function</span>(df, var, val) {</span>
<span id="cb899-2"><a href="evaluation.html#cb899-2" aria-hidden="true" tabindex="-1"></a>  var <span class="ot">&lt;-</span> <span class="fu">as_string</span>(<span class="fu">ensym</span>(var))</span>
<span id="cb899-3"><a href="evaluation.html#cb899-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset2</span>(df, .data[[var]] <span class="sc">&gt;=</span> <span class="sc">!!</span>val)</span>
<span id="cb899-4"><a href="evaluation.html#cb899-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb899-5"><a href="evaluation.html#cb899-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb899-6"><a href="evaluation.html#cb899-6" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb899-7"><a href="evaluation.html#cb899-7" aria-hidden="true" tabindex="-1"></a><span class="fu">threshold_var</span>(df, x, <span class="dv">8</span>)</span>
<span id="cb899-8"><a href="evaluation.html#cb899-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     x</span></span>
<span id="cb899-9"><a href="evaluation.html#cb899-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8   8</span></span>
<span id="cb899-10"><a href="evaluation.html#cb899-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9   9</span></span>
<span id="cb899-11"><a href="evaluation.html#cb899-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 10</span></span></code></pre></div>
<p>It is not always the responsibility of the function author to avoid ambiguity. Imagine we generalise further to allow thresholding based on any expression:</p>
<div class="sourceCode" id="cb900"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb900-1"><a href="evaluation.html#cb900-1" aria-hidden="true" tabindex="-1"></a>threshold_expr <span class="ot">&lt;-</span> <span class="cf">function</span>(df, expr, val) {</span>
<span id="cb900-2"><a href="evaluation.html#cb900-2" aria-hidden="true" tabindex="-1"></a>  expr <span class="ot">&lt;-</span> <span class="fu">enquo</span>(expr)</span>
<span id="cb900-3"><a href="evaluation.html#cb900-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset2</span>(df, <span class="sc">!!</span>expr <span class="sc">&gt;=</span> <span class="sc">!!</span>val)</span>
<span id="cb900-4"><a href="evaluation.html#cb900-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Its not possible to evaluate <code>expr</code> only in the data mask, because the data mask doesnt include any functions like <code>+</code> or <code>==</code>. Here, its the users responsibility to avoid ambiguity. As a general rule of thumb, as a function author its your responsibility to avoid ambiguity with any expressions that you create; its the users responsibility to avoid ambiguity in expressions that they create.</p>
</div>
<div id="exercises-64" class="section level3" number="20.5.4">
<h3><span class="header-section-number">20.5.4</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>Ive included an alternative implementation of <code>threshold_var()</code> below.
What makes it different to the approach I used above? What makes it harder?</p>
<div class="sourceCode" id="cb901"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb901-1"><a href="evaluation.html#cb901-1" aria-hidden="true" tabindex="-1"></a>threshold_var <span class="ot">&lt;-</span> <span class="cf">function</span>(df, var, val) {</span>
<span id="cb901-2"><a href="evaluation.html#cb901-2" aria-hidden="true" tabindex="-1"></a>  var <span class="ot">&lt;-</span> <span class="fu">ensym</span>(var)</span>
<span id="cb901-3"><a href="evaluation.html#cb901-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset2</span>(df, <span class="st">`</span><span class="at">$</span><span class="st">`</span>(.data, <span class="sc">!!</span>var) <span class="sc">&gt;=</span> <span class="sc">!!</span>val)</span>
<span id="cb901-4"><a href="evaluation.html#cb901-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
</ol>
</div>
</div>
<div id="base-evaluation" class="section level2" number="20.6">
<h2><span class="header-section-number">20.6</span> Base evaluation</h2>
<p></p>
<p>Now that you understand tidy evaluation, its time to come back to the alternative approaches taken by base R. Here Ill explore the two most common uses in base R:</p>
<ul>
<li><p><code>substitute()</code> and evaluation in the caller environment, as used by
<code>subset()</code>. Ill use this technique to demonstrate why this technique is not
programming friendly, as warned about in the <code>subset()</code> documentation.</p></li>
<li><p><code>match.call()</code>, call manipulation, and evaluation in the caller environment,
as used by <code>write.csv()</code> and <code>lm()</code>. Ill use this technique to demonstrate how
quasiquotation and (regular) evaluation can help you write wrappers around
such functions.</p></li>
</ul>
<p>These two approaches are common forms of non-standard evaluation (NSE).</p>
<div id="substitute" class="section level3" number="20.6.1">
<h3><span class="header-section-number">20.6.1</span> <code>substitute()</code></h3>
<p>The most common form of NSE in base R is <code>substitute()</code> + <code>eval()</code>. The following code shows how you might write the core of <code>subset()</code> in this style using <code>substitute()</code> and <code>eval()</code> rather than <code>enquo()</code> and <code>eval_tidy()</code>. I repeat the code introduced in Section <a href="evaluation.html#subset">20.4.3</a> so you can compare easily. The main difference is the evaluation environment: in <code>subset_base()</code> the argument is evaluated in the caller environment, while in <code>subset_tidy()</code>, its evaluated in the environment where it was defined.</p>
<div class="sourceCode" id="cb902"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb902-1"><a href="evaluation.html#cb902-1" aria-hidden="true" tabindex="-1"></a>subset_base <span class="ot">&lt;-</span> <span class="cf">function</span>(data, rows) {</span>
<span id="cb902-2"><a href="evaluation.html#cb902-2" aria-hidden="true" tabindex="-1"></a>  rows <span class="ot">&lt;-</span> <span class="fu">substitute</span>(rows)</span>
<span id="cb902-3"><a href="evaluation.html#cb902-3" aria-hidden="true" tabindex="-1"></a>  rows_val <span class="ot">&lt;-</span> <span class="fu">eval</span>(rows, data, <span class="fu">caller_env</span>())</span>
<span id="cb902-4"><a href="evaluation.html#cb902-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(rows_val))</span>
<span id="cb902-5"><a href="evaluation.html#cb902-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb902-6"><a href="evaluation.html#cb902-6" aria-hidden="true" tabindex="-1"></a>  data[rows_val, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb902-7"><a href="evaluation.html#cb902-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb902-8"><a href="evaluation.html#cb902-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb902-9"><a href="evaluation.html#cb902-9" aria-hidden="true" tabindex="-1"></a>subset_tidy <span class="ot">&lt;-</span> <span class="cf">function</span>(data, rows) {</span>
<span id="cb902-10"><a href="evaluation.html#cb902-10" aria-hidden="true" tabindex="-1"></a>  rows <span class="ot">&lt;-</span> <span class="fu">enquo</span>(rows)</span>
<span id="cb902-11"><a href="evaluation.html#cb902-11" aria-hidden="true" tabindex="-1"></a>  rows_val <span class="ot">&lt;-</span> <span class="fu">eval_tidy</span>(rows, data)</span>
<span id="cb902-12"><a href="evaluation.html#cb902-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(rows_val))</span>
<span id="cb902-13"><a href="evaluation.html#cb902-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb902-14"><a href="evaluation.html#cb902-14" aria-hidden="true" tabindex="-1"></a>  data[rows_val, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb902-15"><a href="evaluation.html#cb902-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div id="programming-with-subset" class="section level4" number="20.6.1.1">
<h4><span class="header-section-number">20.6.1.1</span> Programming with <code>subset()</code></h4>
<p>The documentation of <code>subset()</code> includes the following warning:</p>
<blockquote>
<p>This is a convenience function intended for use interactively. For
programming it is better to use the standard subsetting functions like <code>[</code>,
and in particular the non-standard evaluation of argument <code>subset</code> can have
unanticipated consequences.</p>
</blockquote>
<p>There are three main problems:</p>
<ul>
<li><p><code>base::subset()</code> always evaluates <code>rows</code> in the calling environment, but
if <code>...</code> has been used, then the expression might need to be evaluated
elsewhere:</p>
<div class="sourceCode" id="cb903"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb903-1"><a href="evaluation.html#cb903-1" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="cf">function</span>(df, ...) {</span>
<span id="cb903-2"><a href="evaluation.html#cb903-2" aria-hidden="true" tabindex="-1"></a>  xval <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb903-3"><a href="evaluation.html#cb903-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset_base</span>(df, ...)</span>
<span id="cb903-4"><a href="evaluation.html#cb903-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb903-5"><a href="evaluation.html#cb903-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb903-6"><a href="evaluation.html#cb903-6" aria-hidden="true" tabindex="-1"></a>my_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb903-7"><a href="evaluation.html#cb903-7" aria-hidden="true" tabindex="-1"></a>xval <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb903-8"><a href="evaluation.html#cb903-8" aria-hidden="true" tabindex="-1"></a><span class="fu">f1</span>(my_df, x <span class="sc">==</span> xval)</span>
<span id="cb903-9"><a href="evaluation.html#cb903-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   x y</span></span>
<span id="cb903-10"><a href="evaluation.html#cb903-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 3 1</span></span></code></pre></div>
<p>This may seems like an esoteric concern, but it means that <code>subset_base()</code>
cannot reliably work with functionals like <code>map()</code> or <code>lapply()</code>:</p>
<div class="sourceCode" id="cb904"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb904-1"><a href="evaluation.html#cb904-1" aria-hidden="true" tabindex="-1"></a><span class="fu">local</span>({</span>
<span id="cb904-2"><a href="evaluation.html#cb904-2" aria-hidden="true" tabindex="-1"></a>  zzz <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb904-3"><a href="evaluation.html#cb904-3" aria-hidden="true" tabindex="-1"></a>  dfs <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>))</span>
<span id="cb904-4"><a href="evaluation.html#cb904-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(dfs, subset_base, x <span class="sc">==</span> zzz)</span>
<span id="cb904-5"><a href="evaluation.html#cb904-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb904-6"><a href="evaluation.html#cb904-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error in eval(rows, data, caller_env()): object &#39;zzz&#39; not found</span></span></code></pre></div></li>
<li><p>Calling <code>subset()</code> from another function requires some care: you have
to use <code>substitute()</code> to capture a call to <code>subset()</code> complete expression,
and then evaluate. I think this code is hard to understand because
<code>substitute()</code> doesnt use a syntactic marker for unquoting. Here I print
the generated call to make it a little easier to see whats happening.</p>
<div class="sourceCode" id="cb905"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb905-1"><a href="evaluation.html#cb905-1" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="cf">function</span>(df1, expr) {</span>
<span id="cb905-2"><a href="evaluation.html#cb905-2" aria-hidden="true" tabindex="-1"></a>  call <span class="ot">&lt;-</span> <span class="fu">substitute</span>(<span class="fu">subset_base</span>(df1, expr))</span>
<span id="cb905-3"><a href="evaluation.html#cb905-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expr_print</span>(call)</span>
<span id="cb905-4"><a href="evaluation.html#cb905-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(call, <span class="fu">caller_env</span>())</span>
<span id="cb905-5"><a href="evaluation.html#cb905-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb905-6"><a href="evaluation.html#cb905-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb905-7"><a href="evaluation.html#cb905-7" aria-hidden="true" tabindex="-1"></a>my_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb905-8"><a href="evaluation.html#cb905-8" aria-hidden="true" tabindex="-1"></a><span class="fu">f2</span>(my_df, x <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb905-9"><a href="evaluation.html#cb905-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; subset_base(my_df, x == 1)</span></span>
<span id="cb905-10"><a href="evaluation.html#cb905-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   x y</span></span>
<span id="cb905-11"><a href="evaluation.html#cb905-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1 3</span></span></code></pre></div></li>
<li><p><code>eval()</code> doesnt provide any pronouns so theres no way to require part of
the expression to come from the data. As far as I can tell, theres no
way to make the following function safe except by manually checking for the
presence of <code>z</code> variable in <code>df</code>.</p>
<div class="sourceCode" id="cb906"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb906-1"><a href="evaluation.html#cb906-1" aria-hidden="true" tabindex="-1"></a>f3 <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb906-2"><a href="evaluation.html#cb906-2" aria-hidden="true" tabindex="-1"></a>  call <span class="ot">&lt;-</span> <span class="fu">substitute</span>(<span class="fu">subset_base</span>(df, z <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb906-3"><a href="evaluation.html#cb906-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expr_print</span>(call)</span>
<span id="cb906-4"><a href="evaluation.html#cb906-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(call, <span class="fu">caller_env</span>())</span>
<span id="cb906-5"><a href="evaluation.html#cb906-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb906-6"><a href="evaluation.html#cb906-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb906-7"><a href="evaluation.html#cb906-7" aria-hidden="true" tabindex="-1"></a>my_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb906-8"><a href="evaluation.html#cb906-8" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb906-9"><a href="evaluation.html#cb906-9" aria-hidden="true" tabindex="-1"></a><span class="fu">f3</span>(my_df)</span>
<span id="cb906-10"><a href="evaluation.html#cb906-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; subset_base(my_df, z &gt; 0)</span></span>
<span id="cb906-11"><a href="evaluation.html#cb906-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] x y</span></span>
<span id="cb906-12"><a href="evaluation.html#cb906-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;0 rows&gt; (or 0-length row.names)</span></span></code></pre></div></li>
</ul>
</div>
<div id="what-about" class="section level4" number="20.6.1.2">
<h4><span class="header-section-number">20.6.1.2</span> What about <code>[</code>?</h4>
<p>Given that tidy evaluation is quite complex, why not simply use <code>[</code> as <code>?subset</code> recommends? Primarily, it seems unappealing to me to have functions that can only be used interactively, and never inside another function.</p>
<p>Additionally, even the simple <code>subset()</code> function provides two useful features compared to <code>[</code>:</p>
<ul>
<li><p>It sets <code>drop = FALSE</code> by default, so its guaranteed to return a data frame.</p></li>
<li><p>It drops rows where the condition evaluates to <code>NA</code>.</p></li>
</ul>
<p>That means <code>subset(df, x == y)</code> is not equivalent to <code>df[x == y,]</code> as you might expect. Instead, it is equivalent to <code>df[x == y &amp; !is.na(x == y), , drop = FALSE]</code>: thats a lot more typing! Real-life alternatives to <code>subset()</code>, like <code>dplyr::filter()</code>, do even more. For example, <code>dplyr::filter()</code> can translate R expressions to SQL so that they can be executed in a database. This makes programming with <code>filter()</code> relatively more important.</p>
</div>
</div>
<div id="match.call" class="section level3" number="20.6.2">
<h3><span class="header-section-number">20.6.2</span> <code>match.call()</code></h3>
<p>Another common form of NSE is to capture the complete call with <code>match.call()</code>, modify it, and evaluate the result. <code>match.call()</code> is similar to <code>substitute()</code>, but instead of capturing a single argument, it captures the complete call. It doesnt have an equivalent in rlang.</p>
<div class="sourceCode" id="cb907"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb907-1"><a href="evaluation.html#cb907-1" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, z) {</span>
<span id="cb907-2"><a href="evaluation.html#cb907-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">match.call</span>()</span>
<span id="cb907-3"><a href="evaluation.html#cb907-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb907-4"><a href="evaluation.html#cb907-4" aria-hidden="true" tabindex="-1"></a><span class="fu">g</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="at">z =</span> <span class="dv">3</span>)</span>
<span id="cb907-5"><a href="evaluation.html#cb907-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; g(x = 1, y = 2, z = 3)</span></span></code></pre></div>
<p>One prominent user of <code>match.call()</code> is <code>write.csv()</code>, which basically works by transforming the call into a call to <code>write.table()</code> with the appropriate arguments set. The following code shows the heart of <code>write.csv()</code>:</p>
<div class="sourceCode" id="cb908"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb908-1"><a href="evaluation.html#cb908-1" aria-hidden="true" tabindex="-1"></a>write.csv <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb908-2"><a href="evaluation.html#cb908-2" aria-hidden="true" tabindex="-1"></a>  call <span class="ot">&lt;-</span> <span class="fu">match.call</span>(write.table, <span class="at">expand.dots =</span> <span class="cn">TRUE</span>)</span>
<span id="cb908-3"><a href="evaluation.html#cb908-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb908-4"><a href="evaluation.html#cb908-4" aria-hidden="true" tabindex="-1"></a>  call[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">quote</span>(write.table)</span>
<span id="cb908-5"><a href="evaluation.html#cb908-5" aria-hidden="true" tabindex="-1"></a>  call<span class="sc">$</span>sep <span class="ot">&lt;-</span> <span class="st">&quot;,&quot;</span></span>
<span id="cb908-6"><a href="evaluation.html#cb908-6" aria-hidden="true" tabindex="-1"></a>  call<span class="sc">$</span>dec <span class="ot">&lt;-</span> <span class="st">&quot;.&quot;</span></span>
<span id="cb908-7"><a href="evaluation.html#cb908-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb908-8"><a href="evaluation.html#cb908-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(call, <span class="fu">parent.frame</span>())</span>
<span id="cb908-9"><a href="evaluation.html#cb908-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>I dont think this technique is a good idea because you can achieve the same result without NSE:</p>
<div class="sourceCode" id="cb909"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb909-1"><a href="evaluation.html#cb909-1" aria-hidden="true" tabindex="-1"></a>write.csv <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb909-2"><a href="evaluation.html#cb909-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(..., <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb909-3"><a href="evaluation.html#cb909-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Nevertheless, its important to understand this technique because its commonly used in modelling functions. These functions also prominently print the captured call, which poses some special challenges, as youll see next.</p>
<div id="wrapping-modelling-functions" class="section level4" number="20.6.2.1">
<h4><span class="header-section-number">20.6.2.1</span> Wrapping modelling functions</h4>
<p>To begin, consider the simplest possible wrapper around <code>lm()</code>:</p>
<div class="sourceCode" id="cb910"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb910-1"><a href="evaluation.html#cb910-1" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data) {</span>
<span id="cb910-2"><a href="evaluation.html#cb910-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(formula, data)</span>
<span id="cb910-3"><a href="evaluation.html#cb910-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This wrapper works, but is suboptimal because <code>lm()</code> captures its call and displays it when printing.</p>
<div class="sourceCode" id="cb911"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb911-1"><a href="evaluation.html#cb911-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm2</span>(mpg <span class="sc">~</span> disp, mtcars)</span>
<span id="cb911-2"><a href="evaluation.html#cb911-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb911-3"><a href="evaluation.html#cb911-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb911-4"><a href="evaluation.html#cb911-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(formula = formula, data = data)</span></span>
<span id="cb911-5"><a href="evaluation.html#cb911-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb911-6"><a href="evaluation.html#cb911-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb911-7"><a href="evaluation.html#cb911-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Intercept)         disp  </span></span>
<span id="cb911-8"><a href="evaluation.html#cb911-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     29.5999      -0.0412</span></span></code></pre></div>
<p>Fixing this is important because this call is the chief way that you see the model specification when printing the model. To overcome this problem, we need to capture the arguments, create the call to <code>lm()</code> using unquoting, then evaluate that call. To make it easier to see whats going on, Ill also print the expression we generate. This will become more useful as the calls get more complicated.</p>
<div class="sourceCode" id="cb912"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb912-1"><a href="evaluation.html#cb912-1" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data, <span class="at">env =</span> <span class="fu">caller_env</span>()) {</span>
<span id="cb912-2"><a href="evaluation.html#cb912-2" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">enexpr</span>(formula)</span>
<span id="cb912-3"><a href="evaluation.html#cb912-3" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">enexpr</span>(data)</span>
<span id="cb912-4"><a href="evaluation.html#cb912-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb912-5"><a href="evaluation.html#cb912-5" aria-hidden="true" tabindex="-1"></a>  lm_call <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="fu">lm</span>(<span class="sc">!!</span>formula, <span class="at">data =</span> <span class="sc">!!</span>data))</span>
<span id="cb912-6"><a href="evaluation.html#cb912-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expr_print</span>(lm_call)</span>
<span id="cb912-7"><a href="evaluation.html#cb912-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(lm_call, env)</span>
<span id="cb912-8"><a href="evaluation.html#cb912-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb912-9"><a href="evaluation.html#cb912-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb912-10"><a href="evaluation.html#cb912-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lm3</span>(mpg <span class="sc">~</span> disp, mtcars)</span>
<span id="cb912-11"><a href="evaluation.html#cb912-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(mpg ~ disp, data = mtcars)</span></span>
<span id="cb912-12"><a href="evaluation.html#cb912-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb912-13"><a href="evaluation.html#cb912-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb912-14"><a href="evaluation.html#cb912-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(formula = mpg ~ disp, data = mtcars)</span></span>
<span id="cb912-15"><a href="evaluation.html#cb912-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb912-16"><a href="evaluation.html#cb912-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb912-17"><a href="evaluation.html#cb912-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Intercept)         disp  </span></span>
<span id="cb912-18"><a href="evaluation.html#cb912-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     29.5999      -0.0412</span></span></code></pre></div>
<p>There are three pieces that youll use whenever wrapping a base NSE function in this way:</p>
<ul>
<li><p>You capture the unevaluated arguments using <code>enexpr()</code>, and capture the caller
environment using <code>caller_env()</code>.</p></li>
<li><p>You generate a new expression using <code>expr()</code> and unquoting.</p></li>
<li><p>You evaluate that expression in the caller environment. You have to accept
that the function will not work correctly if the arguments are not defined
in the caller environment. Providing the <code>env</code> argument at least provides
a hook that experts can use if the default environment isnt correct.</p></li>
</ul>
<p>The use of <code>enexpr()</code> has a nice side-effect: we can use unquoting to generate formulas dynamically:</p>
<div class="sourceCode" id="cb913"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb913-1"><a href="evaluation.html#cb913-1" aria-hidden="true" tabindex="-1"></a>resp <span class="ot">&lt;-</span> <span class="fu">expr</span>(mpg)</span>
<span id="cb913-2"><a href="evaluation.html#cb913-2" aria-hidden="true" tabindex="-1"></a>disp1 <span class="ot">&lt;-</span> <span class="fu">expr</span>(vs)</span>
<span id="cb913-3"><a href="evaluation.html#cb913-3" aria-hidden="true" tabindex="-1"></a>disp2 <span class="ot">&lt;-</span> <span class="fu">expr</span>(wt)</span>
<span id="cb913-4"><a href="evaluation.html#cb913-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lm3</span>(<span class="sc">!!</span>resp <span class="sc">~</span> <span class="sc">!!</span>disp1 <span class="sc">+</span> <span class="sc">!!</span>disp2, mtcars)</span>
<span id="cb913-5"><a href="evaluation.html#cb913-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(mpg ~ vs + wt, data = mtcars)</span></span>
<span id="cb913-6"><a href="evaluation.html#cb913-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb913-7"><a href="evaluation.html#cb913-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb913-8"><a href="evaluation.html#cb913-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(formula = mpg ~ vs + wt, data = mtcars)</span></span>
<span id="cb913-9"><a href="evaluation.html#cb913-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb913-10"><a href="evaluation.html#cb913-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb913-11"><a href="evaluation.html#cb913-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Intercept)           vs           wt  </span></span>
<span id="cb913-12"><a href="evaluation.html#cb913-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       33.00         3.15        -4.44</span></span></code></pre></div>
</div>
<div id="evaluation-environment" class="section level4" number="20.6.2.2">
<h4><span class="header-section-number">20.6.2.2</span> Evaluation environment</h4>
<p>What if you want to mingle objects supplied by the user with objects that you create in the function? For example, imagine you want to make an auto-resampling version of <code>lm()</code>. You might write it like this:</p>
<div class="sourceCode" id="cb914"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb914-1"><a href="evaluation.html#cb914-1" aria-hidden="true" tabindex="-1"></a>resample_lm0 <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data, <span class="at">env =</span> <span class="fu">caller_env</span>()) {</span>
<span id="cb914-2"><a href="evaluation.html#cb914-2" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">enexpr</span>(formula)</span>
<span id="cb914-3"><a href="evaluation.html#cb914-3" aria-hidden="true" tabindex="-1"></a>  resample_data <span class="ot">&lt;-</span> <span class="fu">resample</span>(data, <span class="at">n =</span> <span class="fu">nrow</span>(data))</span>
<span id="cb914-4"><a href="evaluation.html#cb914-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb914-5"><a href="evaluation.html#cb914-5" aria-hidden="true" tabindex="-1"></a>  lm_call <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="fu">lm</span>(<span class="sc">!!</span>formula, <span class="at">data =</span> resample_data))</span>
<span id="cb914-6"><a href="evaluation.html#cb914-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expr_print</span>(lm_call)</span>
<span id="cb914-7"><a href="evaluation.html#cb914-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(lm_call, env)</span>
<span id="cb914-8"><a href="evaluation.html#cb914-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb914-9"><a href="evaluation.html#cb914-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb914-10"><a href="evaluation.html#cb914-10" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">y =</span> <span class="dv">5</span> <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">10</span>), <span class="dv">2</span>))</span>
<span id="cb914-11"><a href="evaluation.html#cb914-11" aria-hidden="true" tabindex="-1"></a><span class="fu">resample_lm0</span>(y <span class="sc">~</span> x, <span class="at">data =</span> df)</span>
<span id="cb914-12"><a href="evaluation.html#cb914-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(y ~ x, data = resample_data)</span></span>
<span id="cb914-13"><a href="evaluation.html#cb914-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error in is.data.frame(data): object &#39;resample_data&#39; not found</span></span></code></pre></div>
<p>Why doesnt this code work? Were evaluating <code>lm_call</code> in the caller environment, but <code>resample_data</code> exists in the execution environment. We could instead evaluate in the execution environment of <code>resample_lm0()</code>, but theres no guarantee that <code>formula</code> could be evaluated in that environment.</p>
<p>There are two basic ways to overcome this challenge:</p>
<ol style="list-style-type: decimal">
<li><p>Unquote the data frame into the call. This means that no lookup has
to occur, but has all the problems of inlining expressions (Section
<a href="quasiquotation.html#non-standard-ast">19.4.7</a>). For modelling functions this means that the
captured call is suboptimal:</p>
<div class="sourceCode" id="cb915"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb915-1"><a href="evaluation.html#cb915-1" aria-hidden="true" tabindex="-1"></a>resample_lm1 <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data, <span class="at">env =</span> <span class="fu">caller_env</span>()) {</span>
<span id="cb915-2"><a href="evaluation.html#cb915-2" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">enexpr</span>(formula)</span>
<span id="cb915-3"><a href="evaluation.html#cb915-3" aria-hidden="true" tabindex="-1"></a>  resample_data <span class="ot">&lt;-</span> <span class="fu">resample</span>(data, <span class="at">n =</span> <span class="fu">nrow</span>(data))</span>
<span id="cb915-4"><a href="evaluation.html#cb915-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb915-5"><a href="evaluation.html#cb915-5" aria-hidden="true" tabindex="-1"></a>  lm_call <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="fu">lm</span>(<span class="sc">!!</span>formula, <span class="at">data =</span> <span class="sc">!!</span>resample_data))</span>
<span id="cb915-6"><a href="evaluation.html#cb915-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expr_print</span>(lm_call)</span>
<span id="cb915-7"><a href="evaluation.html#cb915-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(lm_call, env)</span>
<span id="cb915-8"><a href="evaluation.html#cb915-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb915-9"><a href="evaluation.html#cb915-9" aria-hidden="true" tabindex="-1"></a><span class="fu">resample_lm1</span>(y <span class="sc">~</span> x, <span class="at">data =</span> df)<span class="sc">$</span>call</span>
<span id="cb915-10"><a href="evaluation.html#cb915-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(y ~ x, data = &lt;data.frame&gt;)</span></span>
<span id="cb915-11"><a href="evaluation.html#cb915-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(formula = y ~ x, data = list(x = c(3L, 7L, 4L, 4L, </span></span>
<span id="cb915-12"><a href="evaluation.html#cb915-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2L, 7L, 2L, 1L, 8L, 9L), y = c(13.21, 27.04, 18.63, </span></span>
<span id="cb915-13"><a href="evaluation.html#cb915-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 18.63, 10.99, 27.04, 10.99, 7.83, 28.14, 32.72)))</span></span></code></pre></div></li>
<li><p>Alternatively you can create a new environment that inherits from the
caller, and bind variables that youve created inside the
function to that environment.</p>
<div class="sourceCode" id="cb916"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb916-1"><a href="evaluation.html#cb916-1" aria-hidden="true" tabindex="-1"></a>resample_lm2 <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data, <span class="at">env =</span> <span class="fu">caller_env</span>()) {</span>
<span id="cb916-2"><a href="evaluation.html#cb916-2" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">enexpr</span>(formula)</span>
<span id="cb916-3"><a href="evaluation.html#cb916-3" aria-hidden="true" tabindex="-1"></a>  resample_data <span class="ot">&lt;-</span> <span class="fu">resample</span>(data, <span class="at">n =</span> <span class="fu">nrow</span>(data))</span>
<span id="cb916-4"><a href="evaluation.html#cb916-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb916-5"><a href="evaluation.html#cb916-5" aria-hidden="true" tabindex="-1"></a>  lm_env <span class="ot">&lt;-</span> <span class="fu">env</span>(env, <span class="at">resample_data =</span> resample_data)</span>
<span id="cb916-6"><a href="evaluation.html#cb916-6" aria-hidden="true" tabindex="-1"></a>  lm_call <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="fu">lm</span>(<span class="sc">!!</span>formula, <span class="at">data =</span> resample_data))</span>
<span id="cb916-7"><a href="evaluation.html#cb916-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expr_print</span>(lm_call)</span>
<span id="cb916-8"><a href="evaluation.html#cb916-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(lm_call, lm_env)</span>
<span id="cb916-9"><a href="evaluation.html#cb916-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb916-10"><a href="evaluation.html#cb916-10" aria-hidden="true" tabindex="-1"></a><span class="fu">resample_lm2</span>(y <span class="sc">~</span> x, <span class="at">data =</span> df)</span>
<span id="cb916-11"><a href="evaluation.html#cb916-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(y ~ x, data = resample_data)</span></span>
<span id="cb916-12"><a href="evaluation.html#cb916-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb916-13"><a href="evaluation.html#cb916-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb916-14"><a href="evaluation.html#cb916-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lm(formula = y ~ x, data = resample_data)</span></span>
<span id="cb916-15"><a href="evaluation.html#cb916-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb916-16"><a href="evaluation.html#cb916-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb916-17"><a href="evaluation.html#cb916-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Intercept)            x  </span></span>
<span id="cb916-18"><a href="evaluation.html#cb916-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;        4.42         3.11</span></span></code></pre></div>
<p>This is more work, but gives the cleanest specification.</p></li>
</ol>
</div>
</div>
<div id="exercises-65" class="section level3" number="20.6.3">
<h3><span class="header-section-number">20.6.3</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>Why does this function fail?</p>
<div class="sourceCode" id="cb917"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb917-1"><a href="evaluation.html#cb917-1" aria-hidden="true" tabindex="-1"></a>lm3a <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data) {</span>
<span id="cb917-2"><a href="evaluation.html#cb917-2" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">enexpr</span>(formula)</span>
<span id="cb917-3"><a href="evaluation.html#cb917-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb917-4"><a href="evaluation.html#cb917-4" aria-hidden="true" tabindex="-1"></a>  lm_call <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="fu">lm</span>(<span class="sc">!!</span>formula, <span class="at">data =</span> data))</span>
<span id="cb917-5"><a href="evaluation.html#cb917-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(lm_call, <span class="fu">caller_env</span>())</span>
<span id="cb917-6"><a href="evaluation.html#cb917-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb917-7"><a href="evaluation.html#cb917-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lm3a</span>(mpg <span class="sc">~</span> disp, mtcars)<span class="sc">$</span>call</span>
<span id="cb917-8"><a href="evaluation.html#cb917-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error in as.data.frame.default(data, optional = TRUE): </span></span>
<span id="cb917-9"><a href="evaluation.html#cb917-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; cannot coerce class &quot;function&quot; to a data.frame</span></span></code></pre></div></li>
<li><p>When model building, typically the response and data are relatively
constant while you rapidly experiment with different predictors. Write a
small wrapper that allows you to reduce duplication in the code below.</p>
<div class="sourceCode" id="cb918"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb918-1"><a href="evaluation.html#cb918-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(mpg <span class="sc">~</span> disp, <span class="at">data =</span> mtcars)</span>
<span id="cb918-2"><a href="evaluation.html#cb918-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(mpg <span class="sc">~</span> <span class="fu">I</span>(<span class="dv">1</span> <span class="sc">/</span> disp), <span class="at">data =</span> mtcars)</span>
<span id="cb918-3"><a href="evaluation.html#cb918-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(mpg <span class="sc">~</span> disp <span class="sc">*</span> cyl, <span class="at">data =</span> mtcars)</span></code></pre></div></li>
<li><p>Another way to write <code>resample_lm()</code> would be to include the
resample expression (<code>data[sample(nrow(data), replace = TRUE), , drop = FALSE]</code>)
in the data argument. Implement that approach. What are the advantages?
What are the disadvantages?</p></li>
</ol>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="104">
<li id="fn104"><p>All other objects yield themselves when evaluated; i.e.<code>eval(x)</code> yields <code>x</code>, except when <code>x</code> is a symbol or expression.<a href="evaluation.html#fnref104" class="footnote-back"></a></p></li>
<li id="fn105"><p>Technically a formula combines an expression and environment, but formulas are tightly coupled to modelling so a new data structure makes sense.<a href="evaluation.html#fnref105" class="footnote-back"></a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="quasiquotation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="translation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/hadley/adv-r/edit/master/Evaluation.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
